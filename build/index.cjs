"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=function(){return t=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},t.apply(this,arguments)};function r(e,t,r,n){return new(r||(r=Promise))(function(a,i){function c(e){try{o(n.next(e))}catch(e){i(e)}}function u(e){try{o(n.throw(e))}catch(e){i(e)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(c,u)}o((n=n.apply(e,t||[])).next())})}function n(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function u(u){return function(o){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;c&&(c=0,u[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&u[0]?n.return:u[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,u[1])).done)return a;switch(n=0,a&&(u=[2&u[0],a.value]),u[0]){case 0:case 1:a=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,n=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!a||u[1]>a[0]&&u[1]<a[3])){i.label=u[1];break}if(6===u[0]&&i.label<a[1]){i.label=a[1],a=u;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(u);break}a[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(e,i)}catch(e){u=[6,e],n=0}finally{r=a=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,o])}}}"function"==typeof SuppressedError&&SuppressedError;var a=new Map,i={get:function(e){var t=a.get(e);if(t)return t.data},set:function(e,t){a.set(e,{data:t,timestamp:Date.now()})},delete:function(e){a.delete(e)},clear:function(){return a.clear()}},c=new Map;function u(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var a,u,o,s=this;return n(this,function(l){return a=t.cacheKey||e,c.has(a)?[2,c.get(a)]:(u=i.get(a))?[2,u]:(o=fetch(e,t).then(function(e){return r(s,void 0,void 0,function(){var t;return n(this,function(r){switch(r.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:return t=r.sent(),i.set(a,t),[2,t]}})})}).finally(function(){return c.delete(a)}),c.set(a,o),[2,o])})})}var o=new Map,s={register:function(e,t,r,n,a){o.set(e,{cacheKey:e,refetch:t,setData:r,cancel:n,cache:a})},getCache:function(e){var t;return null===(t=o.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t){var r,n=o.get(e);n&&(n.cache=t,null===(r=n.setData)||void 0===r||r.call(n,function(){return t}))},setData:function(e,t){var r,n=o.get(e);if(n){var a=t(n.cache);n.cache=a,null===(r=n.setData)||void 0===r||r.call(n,function(){return a})}},cancel:function(e){var t,r;null===(r=null===(t=o.get(e))||void 0===t?void 0:t.cancel)||void 0===r||r.call(t)},invalidate:function(e){var t;e?null===(t=o.get(e))||void 0===t||t.refetch():o.forEach(function(e){return e.refetch()})},unregister:function(e){var t,r;null===(r=null===(t=o.get(e))||void 0===t?void 0:t.cancel)||void 0===r||r.call(t),o.delete(e)}},l=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var r=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(r)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function h(e,t,a){return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,4]),[4,e()];case 1:return[2,n.sent()];case 2:if(r=n.sent(),t<=0)throw r;return[4,new Promise(function(e){return setTimeout(e,a)})];case 3:return n.sent(),[2,h(e,t-1,2*a)];case 4:return[2]}})})}function d(e){var t=new AbortController,r=setTimeout(function(){return t.abort()},e);return t.signal.addEventListener("abort",function(){return clearTimeout(r)}),t.signal}function f(e,t,r){e&&(s.setData(e,function(e){return t?t(e,r):r}),s.invalidate(e))}function v(t,a){var i=this,c=a.query,u=a.variables,o=a.options,v=void 0===o?{}:o,b=e.useState(null),m=b[0],w=b[1],g=e.useState(null),K=g[0],S=g[1],x=e.useState(!1),C=x[0],T=x[1],k=e.useRef(null),U=e.useCallback(function(){return r(i,void 0,void 0,function(){var e,a,i,o,s,l=this;return n(this,function(y){switch(y.label){case 0:T(!0),S(null),null===(o=k.current)||void 0===o||o.abort(),e=new AbortController,k.current=e,a=d(null!==(s=v.timeout)&&void 0!==s?s:1e4),i=function(e,d){return void 0===e&&(e=null!==(o=v.retry)&&void 0!==o?o:3),void 0===d&&(d=null!==(s=v.retryDelay)&&void 0!==s?s:500),r(l,void 0,void 0,function(){var r,o;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,p(t,c,u,{headers:v.headers,cacheKey:v.cacheKey,method:v.method,signal:a})];case 1:return r=n.sent(),w(function(e){return v.optimisticUpdate?v.optimisticUpdate(e,r):r}),f(v.cacheKey,v.optimisticUpdate,r),[2,r];case 2:if("AbortError"===(o=n.sent()).name)throw o;return[2,h(function(){return i(e-1,2*d)},e-1,2*d)];case 3:return[2]}})})},y.label=1;case 1:return y.trys.push([1,,3,4]),[4,i()];case 2:return[2,y.sent()];case 3:return T(!1),[7];case 4:return[2]}})})},[t,c,u,v.cacheKey,v.optimisticUpdate,v.retry,v.retryDelay,v.headers,v.timeout,v.method]),D=e.useCallback(function(){var e;return null===(e=k.current)||void 0===e?void 0:e.abort()},[]);return e.useEffect(function(){var e=!0;return r(i,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return v.prefetch&&v.cacheKey?(r=s.getCache(v.cacheKey))?(w(r),[3,3]):[3,1]:[3,3];case 1:return[4,y(t,{query:c,variables:u,options:{cacheKey:v.cacheKey,headers:v.headers,method:v.method}})];case 2:n.sent(),n.label=3;case 3:return v.autoFetch&&e&&U(),[2]}})}),v.cacheKey&&s.register(v.cacheKey,U,w,D),function(){v.cacheKey&&s.unregister(v.cacheKey),D(),e=!1}},[t,c,u,v.prefetch,v.autoFetch,v.cacheKey,v.method]),e.useEffect(function(){if(v.staleTime){var e=setInterval(U,v.staleTime);return function(){return clearInterval(e)}}},[U,v.staleTime]),e.useEffect(function(){if(v.subscriptionUrl){var e=new l(v.subscriptionUrl).subscribe(function(e){w(function(t){return v.optimisticUpdate?v.optimisticUpdate(t,e):e}),f(v.cacheKey,v.optimisticUpdate,e)});return function(){return e()}}},[v.subscriptionUrl,v.optimisticUpdate,v.cacheKey]),{data:m,error:K,loading:C,refetch:U,mutate:w,cancel:D}}function p(e,a,i,c){var o;return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return a?[4,u(e,{method:"POST",headers:t({"Content-Type":"application/json"},null==c?void 0:c.headers),body:JSON.stringify({query:a,variables:i}),cacheKey:null==c?void 0:c.cacheKey,signal:null==c?void 0:c.signal})]:[3,2];case 1:return[2,n.sent().data];case 2:return r=null!==(o=null==c?void 0:c.method)&&void 0!==o?o:"GET",[4,u(e,{method:r,headers:null==c?void 0:c.headers,cacheKey:null==c?void 0:c.cacheKey,signal:null==c?void 0:c.signal})];case 3:return[2,n.sent()]}})})}function y(e,t){var a=t.query,i=t.variables,c=t.options,u=void 0===c?{}:c;return r(this,void 0,void 0,function(){var t,r,c,o,l;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),t=u.cacheKey,r=u.headers,c=u.method,[4,p(e,a,i,{headers:r,cacheKey:t,method:c})];case 1:return o=n.sent(),t&&s.setCache(t,o),[2,o];case 2:return l=n.sent(),console.error("Prefetch failed",l),[2,null];case 3:return[2]}})})}exports.SubscriptionManager=l,exports.cache=i,exports.createTimeoutSignal=d,exports.prefetchQuery=y,exports.queryRegistry=s,exports.retryOperation=h,exports.updateCache=f,exports.useGraphQLMutation=function(a,i){var c=this,o=i.mutation,l=i.variables,f=i.cacheKey,v=i.optimisticUpdate,p=i.retry,y=void 0===p?3:p,b=i.retryDelay,m=void 0===b?500:b,w=i.headers,g=i.timeout,K=void 0===g?1e4:g,S=e.useRef(null),x=e.useCallback(function(){return r(c,void 0,void 0,function(){var e,i,c,p,b=this;return n(this,function(g){switch(g.label){case 0:null===(p=S.current)||void 0===p||p.abort(),e=new AbortController,S.current=e,i=d(K),c=function(e,d){return r(b,void 0,void 0,function(){var r,p;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,u(a,{method:"POST",headers:t({"Content-Type":"application/json"},w),body:JSON.stringify({query:o,variables:l}),signal:i,cacheKey:f})];case 1:return r=n.sent(),v&&f&&s.setData(f,function(e){return v(e,r.data)}),f&&s.invalidate(f),[2,r.data];case 2:if("AbortError"===(p=n.sent()).name)throw p;return[2,h(function(){return c(e-1,2*d)},e-1,2*d)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,c(y,m)];case 2:return[2,g.sent()];case 3:return[7];case 4:return[2]}})})},[a,o,l,f,v,y,m,w,K]),C=e.useCallback(function(){var e;null===(e=S.current)||void 0===e||e.abort()},[]);return{mutate:x,cancel:C}},exports.useGraphQLQuery=function(e,t){return v(e,{query:t.query,variables:t.variables,options:{cacheKey:t.cacheKey,staleTime:t.staleTime,headers:t.headers,timeout:t.timeout,retry:t.retry,retryDelay:t.retryDelay,optimisticUpdate:t.optimisticUpdate}})},exports.useHybridQuery=v,exports.useMutation=function(a,i){var c=this,o=e.useState(!1),l=o[0],f=o[1],v=e.useState(null),p=v[0],y=v[1],b=e.useRef(null),m=e.useCallback(function(e,o){return void 0===o&&(o="POST"),r(c,void 0,void 0,function(){var c,l,v,p,m,w=this;return n(this,function(g){switch(g.label){case 0:f(!0),y(null),null===(p=b.current)||void 0===p||p.abort(),c=new AbortController,b.current=c,l=d(null!==(m=null==i?void 0:i.timeout)&&void 0!==m?m:1e4),v=function(c,d){return void 0===c&&(c=null!==(p=null==i?void 0:i.retry)&&void 0!==p?p:3),void 0===d&&(d=null!==(m=null==i?void 0:i.retryDelay)&&void 0!==m?m:500),r(w,void 0,void 0,function(){var r,f,p;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,u(a,{method:o,headers:t({"Content-Type":"application/json"},null==i?void 0:i.headers),body:JSON.stringify(e),cacheKey:null==i?void 0:i.cacheKey,signal:l})];case 1:return r=n.sent(),(null==i?void 0:i.optimisticUpdate)&&i.cacheKey&&(s.setData(i.cacheKey,function(e){return i.optimisticUpdate(e,r)}),s.invalidate(i.cacheKey)),null===(p=null==i?void 0:i.onSuccess)||void 0===p||p.call(i,r),[2,r];case 2:if("AbortError"===(f=n.sent()).name)throw f;return[2,h(function(){return v(c-1,2*d)},c-1,2*d)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,v()];case 2:return[2,g.sent()];case 3:return f(!1),[7];case 4:return[2]}})})},[a,i]),w=e.useCallback(function(){var e;return null===(e=b.current)||void 0===e?void 0:e.abort()},[]);return{mutate:m,loading:l,error:p,cancel:w}},exports.useQuery=function(e,t){return v(e,t)};
