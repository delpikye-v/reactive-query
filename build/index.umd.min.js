!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ReactiveQuery={},e.React)}(this,function(e,t){"use strict";var n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function u(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,u)}c((r=r.apply(e,t||[])).next())})}function i(e,t){var n,r,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=u(0),o.throw=u(1),o.return=u(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(c){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&u[0]?r.return:u[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,u[1])).done)return i;switch(r=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){a.label=u[1];break}if(6===u[0]&&a.label<i[1]){a.label=i[1],i=u;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(u);break}i[2]&&a.ops.pop(),a.trys.pop();continue}u=t.call(e,a)}catch(e){u=[6,e],r=0}finally{n=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}}"function"==typeof SuppressedError&&SuppressedError;var a=[];function o(e,t,n,o){return r(this,void 0,void 0,function(){var r,u,c;return i(this,function(i){switch(i.label){case 0:r={endpoint:e,body:t,method:n,options:o},u=0,c=a,i.label=1;case 1:return u<c.length?[4,c[u].fn(r)]:[3,4];case 2:r=i.sent(),i.label=3;case 3:return u++,[3,1];case 4:return[2,r]}})})}var u=new Map,c={get:function(e){var t=u.get(e);if(t)return t.data},set:function(e,t){u.set(e,{data:t,timestamp:Date.now()})},delete:function(e){u.delete(e)},clear:function(){return u.clear()}},s=new Map;function l(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var n,a,o,u=this;return i(this,function(l){return n=t.cacheKey||e,s.has(n)?[2,s.get(n)]:(a=c.get(n))?[2,a]:(o=fetch(e,t).then(function(e){return r(u,void 0,void 0,function(){var t;return i(this,function(r){switch(r.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:return t=r.sent(),c.set(n,t),[2,t]}})})}).finally(function(){return s.delete(n)}),s.set(n,o),[2,o])})})}var d=new Map,f={register:function(e,t,n,r,i){d.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=d.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t){var n,r=d.get(e);r&&(r.cache=t,null===(n=r.setData)||void 0===n||n.call(r,function(){return t}))},setData:function(e,t){var n,r=d.get(e);if(r){var i=t(r.cache);r.cache=i,null===(n=r.setData)||void 0===n||n.call(r,function(){return i})}},cancel:function(e){var t,n;null===(n=null===(t=d.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;e?null===(t=d.get(e))||void 0===t||t.refetch():d.forEach(function(e){return e.refetch()})},unregister:function(e){var t,n;null===(n=null===(t=d.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),d.delete(e)}},h=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function v(e,t,n){return r(this,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,4]),[4,e()];case 1:return[2,i.sent()];case 2:if(r=i.sent(),t<=0)throw r;return[4,new Promise(function(e){return setTimeout(e,n)})];case 3:return i.sent(),[2,v(e,t-1,n)];case 4:return[2]}})})}function p(e){var t=new AbortController;return setTimeout(function(){return t.abort()},e),t.signal}function y(e,t,n){e&&(f.setData(e,function(e){return t?t(e,n):n}),f.invalidate(e))}function b(e,a){var o=this,u=a.query,c=a.variables,s=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(a,["query","variables"]),l=t.useState(null),d=l[0],b=l[1],g=t.useState(null),K=g[0],O=g[1],S=t.useState(!1),C=S[0],k=S[1],T=t.useRef(null),j=t.useCallback(function(){return r(o,void 0,void 0,function(){var t,a,o,l,d,f=this;return i(this,function(h){switch(h.label){case 0:k(!0),O(null),null===(l=T.current)||void 0===l||l.abort(),t=new AbortController,T.current=t,a=p(null!==(d=s.timeout)&&void 0!==d?d:1e4),o=function(t,h){return void 0===t&&(t=null!==(l=s.retry)&&void 0!==l?l:3),void 0===h&&(h=null!==(d=s.retryDelay)&&void 0!==d?d:500),r(f,void 0,void 0,function(){var r,l;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,m(e,n(n({query:u,variables:c},s),{signal:a}))];case 1:return r=i.sent(),b(function(e){return s.optimisticUpdate?s.optimisticUpdate(e,r):r}),y(s.cacheKey,s.optimisticUpdate,r),[2,r];case 2:if("AbortError"===(l=i.sent()).name)throw l;return[2,v(function(){return o(t-1,2*h)},t-1,2*h)];case 3:return[2]}})})},h.label=1;case 1:return h.trys.push([1,,3,4]),[4,o()];case 2:return[2,h.sent()];case 3:return k(!1),[7];case 4:return[2]}})})},[e,u,c,s.cacheKey,s.headers,s.method,s.timeout,s.retry,s.retryDelay,s.optimisticUpdate]),E=t.useCallback(function(){var e;null===(e=T.current)||void 0===e||e.abort()},[]);return t.useEffect(function(){var t=!0;return r(o,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return s.prefetch&&s.cacheKey?(r=f.getCache(s.cacheKey))?(b(r),[3,3]):[3,1]:[3,3];case 1:return[4,w(e,n({query:u,variables:c},s))];case 2:i.sent(),i.label=3;case 3:return s.autoFetch&&t&&j(),[2]}})}),s.cacheKey&&f.register(s.cacheKey,j,b,E),function(){t=!1,E(),s.cacheKey&&f.unregister(s.cacheKey)}},[e,u,c,s.prefetch,s.autoFetch,s.cacheKey]),t.useEffect(function(){if(s.staleTime){var e=setInterval(j,s.staleTime);return function(){return clearInterval(e)}}},[j,s.staleTime]),t.useEffect(function(){if(s.subscriptionUrl){var e=new h(s.subscriptionUrl).subscribe(function(e){b(function(t){return s.optimisticUpdate?s.optimisticUpdate(t,e):e}),y(s.cacheKey,s.optimisticUpdate,e)});return function(){return e()}}},[s.subscriptionUrl]),{data:d,error:K,loading:C,refetch:j,setData:b,cancel:E}}function m(e,t){var a;return r(this,void 0,void 0,function(){var r,u,c,s,d;return i(this,function(i){switch(i.label){case 0:return r=null!==(a=t.method)&&void 0!==a?a:t.query?"POST":"GET",[4,o(e,t.query?{query:t.query,variables:t.variables}:void 0,r,{headers:t.headers,cacheKey:t.cacheKey,signal:t.signal})];case 1:return u=i.sent(),c=u.body,s=u.method,d=u.options,t.query?[4,l(e,{method:s,headers:n({"Content-Type":"application/json"},null==d?void 0:d.headers),body:JSON.stringify(c),cacheKey:null==d?void 0:d.cacheKey,signal:null==d?void 0:d.signal})]:[3,3];case 2:return[2,i.sent().data];case 3:return[2,l(e,{method:s,headers:null==d?void 0:d.headers,cacheKey:null==d?void 0:d.cacheKey,signal:null==d?void 0:d.signal})]}})})}function w(e,t){return r(this,void 0,void 0,function(){var n;return i(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,m(e,t)];case 1:return n=r.sent(),t.cacheKey&&f.setCache(t.cacheKey,n),[2,n];case 2:return r.sent(),[2,null];case 3:return[2]}})})}e.SubscriptionManager=h,e.cache=c,e.createTimeoutSignal=p,e.prefetchQuery=w,e.queryRegistry=f,e.removeMiddleware=function(e){var t=a.findIndex(function(t){return t.name===e});t>=0&&a.splice(t,1)},e.retryOperation=v,e.runMiddlewares=o,e.updateCache=y,e.useGraphQLMutation=function(e,a){var u=this,c=a.mutation,s=a.variables,d=a.cacheKey,h=a.optimisticUpdate,y=a.retry,b=void 0===y?3:y,m=a.retryDelay,w=void 0===m?500:m,g=a.timeout,K=void 0===g?1e4:g,O=t.useRef(null),S=t.useCallback(function(){return r(u,void 0,void 0,function(){var t,u,y,m=this;return i(this,function(g){return null===(y=O.current)||void 0===y||y.abort(),O.current=new AbortController,t=p(K),u=function(p,y){return r(m,void 0,void 0,function(){var r,b,m,w,g,K;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,o(e,{query:c,variables:s},"POST",{headers:a.headers,cacheKey:d,signal:t})];case 1:return r=i.sent(),[4,l(e,{method:r.method,headers:n({"Content-Type":"application/json"},null===(w=r.options)||void 0===w?void 0:w.headers),body:JSON.stringify(r.body),cacheKey:null===(g=r.options)||void 0===g?void 0:g.cacheKey,signal:null===(K=r.options)||void 0===K?void 0:K.signal})];case 2:return b=i.sent(),h&&d&&(f.setData(d,function(e){return h(e,b.data)}),f.invalidate(d)),[2,b.data];case 3:if("AbortError"===(m=i.sent()).name)throw m;return[2,v(function(){return u(p-1,2*y)},p-1,2*y)];case 4:return[2]}})})},[2,u(b,w)]})})},[e,c,s,d]),C=t.useCallback(function(){var e;null===(e=O.current)||void 0===e||e.abort()},[]);return{mutate:S,cancel:C}},e.useGraphQLQuery=function(e,t){return b(e,t)},e.useHybridQuery=b,e.useMiddleware=function(e,t){a.find(function(t){return t.name===e})||a.push({name:e,fn:t})},e.useMutation=function(e,a){var u=this,c=t.useState(!1),s=c[0],d=c[1],h=t.useState(null),y=h[0],b=h[1],m=t.useRef(null),w=t.useCallback(function(t,c){return void 0===c&&(c="POST"),r(u,void 0,void 0,function(){var u,s,h,y,w,g=this;return i(this,function(K){switch(K.label){case 0:d(!0),b(null),null===(y=m.current)||void 0===y||y.abort(),u=new AbortController,m.current=u,s=p(null!==(w=null==a?void 0:a.timeout)&&void 0!==w?w:1e4),h=function(u,d){return void 0===u&&(u=null!==(y=null==a?void 0:a.retry)&&void 0!==y?y:3),void 0===d&&(d=null!==(w=null==a?void 0:a.retryDelay)&&void 0!==w?w:500),r(g,void 0,void 0,function(){var r,p,y,b,m,w,g,K;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,o(e,t,c,{headers:null==a?void 0:a.headers,cacheKey:null==a?void 0:a.cacheKey,signal:s})];case 1:return r=i.sent(),[4,l(e,{method:r.method,headers:n({"Content-Type":"application/json"},null===(b=r.options)||void 0===b?void 0:b.headers),body:JSON.stringify(r.body),cacheKey:null===(m=r.options)||void 0===m?void 0:m.cacheKey,signal:null===(w=r.options)||void 0===w?void 0:w.signal})];case 2:return p=i.sent(),(null==a?void 0:a.optimisticUpdate)&&(null===(g=r.options)||void 0===g?void 0:g.cacheKey)&&(f.setData(r.options.cacheKey,function(e){return a.optimisticUpdate(e,p)}),f.invalidate(r.options.cacheKey)),null===(K=null==a?void 0:a.onSuccess)||void 0===K||K.call(a,p),[2,p];case 3:if("AbortError"===(y=i.sent()).name)throw y;return[2,v(function(){return h(u-1,2*d)},u-1,2*d)];case 4:return[2]}})})},K.label=1;case 1:return K.trys.push([1,,3,4]),[4,h()];case 2:return[2,K.sent()];case 3:return d(!1),[7];case 4:return[2]}})})},[e,a]),g=t.useCallback(function(){var e;null===(e=m.current)||void 0===e||e.abort()},[]);return{mutate:w,loading:s,error:y,cancel:g}},e.useQuery=function(e,t){return b(e,t)},Object.defineProperty(e,"__esModule",{value:!0})});
