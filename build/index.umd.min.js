!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ReactiveQuery={},e.React)}(this,function(e,t){"use strict";var n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))(function(i,a){function c(e){try{o(r.next(e))}catch(e){a(e)}}function u(e){try{o(r.throw(e))}catch(e){a(e)}}function o(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,u)}o((r=r.apply(e,t||[])).next())})}function i(e,t){var n,r,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function u(u){return function(o){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&u[0]?r.return:u[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,u[1])).done)return i;switch(r=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){a.label=u[1];break}if(6===u[0]&&a.label<i[1]){a.label=i[1],i=u;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(u);break}i[2]&&a.ops.pop(),a.trys.pop();continue}u=t.call(e,a)}catch(e){u=[6,e],r=0}finally{n=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,o])}}}"function"==typeof SuppressedError&&SuppressedError;var a=new Map,c={get:function(e){var t=a.get(e);if(t)return t.data},set:function(e,t){a.set(e,{data:t,timestamp:Date.now()})},delete:function(e){a.delete(e)},clear:function(){return a.clear()}},u=new Map;function o(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var n,a,o,s=this;return i(this,function(l){return n=t.cacheKey||e,u.has(n)?[2,u.get(n)]:(a=c.get(n))?[2,a]:(o=fetch(e,t).then(function(e){return r(s,void 0,void 0,function(){var t;return i(this,function(r){switch(r.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:return t=r.sent(),c.set(n,t),[2,t]}})})}).finally(function(){return u.delete(n)}),u.set(n,o),[2,o])})})}var s=new Map,l={register:function(e,t,n,r,i){s.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=s.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t){var n,r=s.get(e);r&&(r.cache=t,null===(n=r.setData)||void 0===n||n.call(r,function(){return t}))},setData:function(e,t){var n,r=s.get(e);if(r){var i=t(r.cache);r.cache=i,null===(n=r.setData)||void 0===n||n.call(r,function(){return i})}},cancel:function(e){var t,n;null===(n=null===(t=s.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;e?null===(t=s.get(e))||void 0===t||t.refetch():s.forEach(function(e){return e.refetch()})},unregister:function(e){var t,n;null===(n=null===(t=s.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),s.delete(e)}},f=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function h(e,t,n){return r(this,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,4]),[4,e()];case 1:return[2,i.sent()];case 2:if(r=i.sent(),t<=0)throw r;return[4,new Promise(function(e){return setTimeout(e,n)})];case 3:return i.sent(),[2,h(e,t-1,2*n)];case 4:return[2]}})})}function d(e){var t=new AbortController,n=setTimeout(function(){return t.abort()},e);return t.signal.addEventListener("abort",function(){return clearTimeout(n)}),t.signal}function v(e,t,n){e&&(l.setData(e,function(e){return t?t(e,n):n}),l.invalidate(e))}function y(e,t,n,a,c,u){return r(this,void 0,void 0,function(){var r,o;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,b(e,t,n,{headers:c,cacheKey:a,method:u})];case 1:return r=i.sent(),a&&l.setCache(a,r),[2,r];case 2:return o=i.sent(),console.error("Prefetch failed",o),[2,null];case 3:return[2]}})})}function p(e,n){var a=this,c=n.query,u=n.variables,o=n.options,s=void 0===o?{}:o,p=t.useState(null),m=p[0],w=p[1],g=t.useState(null),K=g[0],S=g[1],T=t.useState(!1),C=T[0],k=T[1],U=t.useRef(null),D=t.useCallback(function(){return r(a,void 0,void 0,function(){var t,n,a,o,l,f=this;return i(this,function(y){switch(y.label){case 0:k(!0),S(null),null===(o=U.current)||void 0===o||o.abort(),t=new AbortController,U.current=t,n=d(null!==(l=s.timeout)&&void 0!==l?l:1e4),a=function(t,d){return void 0===t&&(t=null!==(o=s.retry)&&void 0!==o?o:3),void 0===d&&(d=null!==(l=s.retryDelay)&&void 0!==l?l:500),r(f,void 0,void 0,function(){var r,o;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,b(e,c,u,{headers:s.headers,cacheKey:s.cacheKey,method:s.method,signal:n})];case 1:return r=i.sent(),w(function(e){return s.optimisticUpdate?s.optimisticUpdate(e,r):r}),v(s.cacheKey,s.optimisticUpdate,r),[2,r];case 2:if("AbortError"===(o=i.sent()).name)throw o;return[2,h(function(){return a(t-1,2*d)},t-1,2*d)];case 3:return[2]}})})},y.label=1;case 1:return y.trys.push([1,,3,4]),[4,a()];case 2:return[2,y.sent()];case 3:return k(!1),[7];case 4:return[2]}})})},[e,c,u,s.cacheKey,s.optimisticUpdate,s.retry,s.retryDelay,s.headers,s.timeout,s.method]),E=t.useCallback(function(){var e;return null===(e=U.current)||void 0===e?void 0:e.abort()},[]);return t.useEffect(function(){var t=!0;return r(a,void 0,void 0,function(){var n;return i(this,function(r){switch(r.label){case 0:return s.prefetch&&s.cacheKey?(n=l.getCache(s.cacheKey))?(w(n),[3,3]):[3,1]:[3,3];case 1:return[4,y(e,c,u,s.cacheKey,s.headers,s.method)];case 2:r.sent(),r.label=3;case 3:return s.autoFetch&&t&&D(),[2]}})}),s.cacheKey&&l.register(s.cacheKey,D,w,E),function(){s.cacheKey&&l.unregister(s.cacheKey),E(),t=!1}},[e,c,u,s.prefetch,s.autoFetch,s.cacheKey,s.method]),t.useEffect(function(){if(s.staleTime){var e=setInterval(D,s.staleTime);return function(){return clearInterval(e)}}},[D,s.staleTime]),t.useEffect(function(){if(s.subscriptionUrl){var e=new f(s.subscriptionUrl).subscribe(function(e){w(function(t){return s.optimisticUpdate?s.optimisticUpdate(t,e):e}),v(s.cacheKey,s.optimisticUpdate,e)});return function(){return e()}}},[s.subscriptionUrl,s.optimisticUpdate,s.cacheKey]),{data:m,error:K,loading:C,refetch:D,mutate:w,cancel:E}}function b(e,t,a,c){var u;return r(this,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return t?[4,o(e,{method:"POST",headers:n({"Content-Type":"application/json"},null==c?void 0:c.headers),body:JSON.stringify({query:t,variables:a}),cacheKey:null==c?void 0:c.cacheKey,signal:null==c?void 0:c.signal})]:[3,2];case 1:return[2,i.sent().data];case 2:return r=null!==(u=null==c?void 0:c.method)&&void 0!==u?u:"GET",[4,o(e,{method:r,headers:null==c?void 0:c.headers,cacheKey:null==c?void 0:c.cacheKey,signal:null==c?void 0:c.signal})];case 3:return[2,i.sent()]}})})}e.SubscriptionManager=f,e.cache=c,e.createTimeoutSignal=d,e.queryRegistry=l,e.retryOperation=h,e.updateCache=v,e.useGraphQLMutation=function(e,a){var c=this,u=a.mutation,s=a.variables,f=a.cacheKey,v=a.optimisticUpdate,y=a.retry,p=void 0===y?3:y,b=a.retryDelay,m=void 0===b?500:b,w=a.headers,g=a.timeout,K=void 0===g?1e4:g,S=t.useRef(null),T=t.useCallback(function(){return r(c,void 0,void 0,function(){var t,a,c,y,b=this;return i(this,function(g){switch(g.label){case 0:null===(y=S.current)||void 0===y||y.abort(),t=new AbortController,S.current=t,a=d(K),c=function(t,d){return r(b,void 0,void 0,function(){var r,y;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,o(e,{method:"POST",headers:n({"Content-Type":"application/json"},w),body:JSON.stringify({query:u,variables:s}),signal:a,cacheKey:f})];case 1:return r=i.sent(),v&&f&&l.setData(f,function(e){return v(e,r.data)}),f&&l.invalidate(f),[2,r.data];case 2:if("AbortError"===(y=i.sent()).name)throw y;return[2,h(function(){return c(t-1,2*d)},t-1,2*d)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,c(p,m)];case 2:return[2,g.sent()];case 3:return[7];case 4:return[2]}})})},[e,u,s,f,v,p,m,w,K]),C=t.useCallback(function(){var e;null===(e=S.current)||void 0===e||e.abort()},[]);return{mutate:T,cancel:C}},e.useGraphQLQuery=function(e,t){return p(e,{query:t.query,variables:t.variables,options:{cacheKey:t.cacheKey,staleTime:t.staleTime,headers:t.headers,timeout:t.timeout,retry:t.retry,retryDelay:t.retryDelay,optimisticUpdate:t.optimisticUpdate}})},e.useHybridQuery=p,e.useMutation=function(e,a){var c=this,u=t.useState(!1),s=u[0],f=u[1],v=t.useState(null),y=v[0],p=v[1],b=t.useRef(null),m=t.useCallback(function(t,u){return void 0===u&&(u="POST"),r(c,void 0,void 0,function(){var c,s,v,y,m,w=this;return i(this,function(g){switch(g.label){case 0:f(!0),p(null),null===(y=b.current)||void 0===y||y.abort(),c=new AbortController,b.current=c,s=d(null!==(m=null==a?void 0:a.timeout)&&void 0!==m?m:1e4),v=function(c,f){return void 0===c&&(c=null!==(y=null==a?void 0:a.retry)&&void 0!==y?y:3),void 0===f&&(f=null!==(m=null==a?void 0:a.retryDelay)&&void 0!==m?m:500),r(w,void 0,void 0,function(){var r,d,y;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,o(e,{method:u,headers:n({"Content-Type":"application/json"},null==a?void 0:a.headers),body:JSON.stringify(t),cacheKey:null==a?void 0:a.cacheKey,signal:s})];case 1:return r=i.sent(),(null==a?void 0:a.optimisticUpdate)&&a.cacheKey&&(l.setData(a.cacheKey,function(e){return a.optimisticUpdate(e,r)}),l.invalidate(a.cacheKey)),null===(y=null==a?void 0:a.onSuccess)||void 0===y||y.call(a,r),[2,r];case 2:if("AbortError"===(d=i.sent()).name)throw d;return[2,h(function(){return v(c-1,2*f)},c-1,2*f)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,v()];case 2:return[2,g.sent()];case 3:return f(!1),[7];case 4:return[2]}})})},[e,a]),w=t.useCallback(function(){var e;return null===(e=b.current)||void 0===e?void 0:e.abort()},[]);return{mutate:m,loading:s,error:y,cancel:w}},e.useQuery=function(e,t){return p(e,t)},Object.defineProperty(e,"__esModule",{value:!0})});
