!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ReactiveQuery={},e.React)}(this,function(e,t){"use strict";var n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))(function(i,a){function u(e){try{c(r.next(e))}catch(e){a(e)}}function o(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(u,o)}c((r=r.apply(e,t||[])).next())})}function i(e,t){var n,r,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},u=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return u.next=o(0),u.throw=o(1),u.return=o(2),"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;u&&(u=0,o[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}"function"==typeof SuppressedError&&SuppressedError;var a=new Map,u={get:function(e){var t=a.get(e);if(t)return t.data},set:function(e,t){a.set(e,{data:t,timestamp:Date.now()})},delete:function(e){a.delete(e)},clear:function(){return a.clear()}},o=new Map;function c(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var n,a,c,s=this;return i(this,function(l){return n=t.cacheKey||e,o.has(n)?[2,o.get(n)]:(a=u.get(n))?[2,a]:(c=fetch(e,t).then(function(e){return r(s,void 0,void 0,function(){var t;return i(this,function(r){switch(r.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:return t=r.sent(),u.set(n,t),[2,t]}})})}).finally(function(){return o.delete(n)}),o.set(n,c),[2,c])})})}var s=new Map,l={register:function(e,t,n,r){s.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r})},setData:function(e,t){var n=s.get(e);(null==n?void 0:n.setData)&&n.setData(t)},cancel:function(e){var t,n=s.get(e);null===(t=null==n?void 0:n.cancel)||void 0===t||t.call(n)},invalidate:function(e){var t;e?null===(t=s.get(e))||void 0===t||t.refetch():s.forEach(function(e){return e.refetch()})},unregister:function(e){var t,n;null===(n=null===(t=s.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),s.delete(e)}},f=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function d(e,t,n){return r(this,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,4]),[4,e()];case 1:return[2,i.sent()];case 2:if(r=i.sent(),t<=0)throw r;return[4,new Promise(function(e){return setTimeout(e,n)})];case 3:return i.sent(),[2,d(e,t-1,2*n)];case 4:return[2]}})})}function h(e){var t=new AbortController,n=setTimeout(function(){return t.abort()},e);return t.signal.addEventListener("abort",function(){return clearTimeout(n)}),t.signal}function v(e,t,n){e&&(l.setData(e,function(e){return t?t(e,n):n}),l.invalidate(e))}function p(e,a){var u=this,o=a.query,s=a.variables,p=a.options,y=void 0===p?{}:p,b=t.useState(null),m=b[0],w=b[1],g=t.useState(null),K=g[0],S=g[1],T=t.useState(!1),k=T[0],U=T[1],C=t.useRef(null),D=t.useCallback(function(){return r(u,void 0,void 0,function(){var t,a,u,l,f,p=this;return i(this,function(b){switch(b.label){case 0:U(!0),S(null),null===(l=C.current)||void 0===l||l.abort(),t=new AbortController,C.current=t,a=h(null!==(f=y.timeout)&&void 0!==f?f:1e4),u=function(t,h){return void 0===t&&(t=null!==(l=y.retry)&&void 0!==l?l:3),void 0===h&&(h=null!==(f=y.retryDelay)&&void 0!==f?f:500),r(p,void 0,void 0,function(){var r,l,f;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,5,,6]),o?[4,c(e,{method:"POST",headers:n({"Content-Type":"application/json"},y.headers),body:JSON.stringify({query:o,variables:s}),cacheKey:y.cacheKey,signal:a})]:[3,2];case 1:return l=i.sent(),r=l.data,[3,4];case 2:return[4,c(e,{cacheKey:y.cacheKey,signal:a,headers:y.headers})];case 3:r=i.sent(),i.label=4;case 4:return w(function(e){return y.optimisticUpdate?y.optimisticUpdate(e,r):r}),v(y.cacheKey,y.optimisticUpdate,r),[2,r];case 5:if("AbortError"===(f=i.sent()).name)throw f;return[2,d(function(){return u(t-1,2*h)},t-1,2*h)];case 6:return[2]}})})},b.label=1;case 1:return b.trys.push([1,,3,4]),[4,u()];case 2:return[2,b.sent()];case 3:return U(!1),[7];case 4:return[2]}})})},[e,o,s,y.cacheKey,y.optimisticUpdate,y.retry,y.retryDelay,y.headers,y.timeout]),O=t.useCallback(function(){var e;return null===(e=C.current)||void 0===e?void 0:e.abort()},[]);return t.useEffect(function(){return y.cacheKey&&l.register(y.cacheKey,D,w,O),function(){y.cacheKey&&l.unregister(y.cacheKey),O()}},[y.cacheKey,D,w,O]),t.useEffect(function(){if(y.staleTime){var e=setInterval(D,y.staleTime);return function(){return clearInterval(e)}}},[D,y.staleTime]),t.useEffect(function(){if(y.subscriptionUrl){var e=new f(y.subscriptionUrl).subscribe(function(e){w(function(t){return y.optimisticUpdate?y.optimisticUpdate(t,e):e}),v(y.cacheKey,y.optimisticUpdate,e)});return function(){return e()}}},[y.subscriptionUrl,y.optimisticUpdate,y.cacheKey]),{data:m,error:K,loading:k,refetch:D,mutate:w,cancel:O}}e.SubscriptionManager=f,e.cache=u,e.createTimeoutSignal=h,e.queryRegistry=l,e.retryOperation=d,e.updateCache=v,e.useGraphQLMutation=function(e,a){var u=this,o=a.mutation,s=a.variables,f=a.cacheKey,v=a.optimisticUpdate,p=a.retry,y=void 0===p?3:p,b=a.retryDelay,m=void 0===b?500:b,w=a.headers,g=a.timeout,K=void 0===g?1e4:g,S=t.useRef(null),T=t.useCallback(function(){return r(u,void 0,void 0,function(){var t,a,u,p,b=this;return i(this,function(g){switch(g.label){case 0:null===(p=S.current)||void 0===p||p.abort(),t=new AbortController,S.current=t,a=h(K),u=function(t,h){return r(b,void 0,void 0,function(){var r,p;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,c(e,{method:"POST",headers:n({"Content-Type":"application/json"},w),body:JSON.stringify({query:o,variables:s}),signal:a,cacheKey:f})];case 1:return r=i.sent(),v&&f&&l.setData(f,function(e){return v(e,r.data)}),f&&l.invalidate(f),[2,r.data];case 2:if("AbortError"===(p=i.sent()).name)throw p;return[2,d(function(){return u(t-1,2*h)},t-1,2*h)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,u(y,m)];case 2:return[2,g.sent()];case 3:return[7];case 4:return[2]}})})},[e,o,s,f,v,y,m,w,K]),k=t.useCallback(function(){var e;null===(e=S.current)||void 0===e||e.abort()},[]);return{mutate:T,cancel:k}},e.useGraphQLQuery=function(e,t){return p(e,{query:t.query,variables:t.variables,options:{cacheKey:t.cacheKey,staleTime:t.staleTime,headers:t.headers,timeout:t.timeout,retry:t.retry,retryDelay:t.retryDelay,optimisticUpdate:t.optimisticUpdate}})},e.useHybridQuery=p,e.useMutation=function(e,a){var u=this,o=t.useState(!1),s=o[0],f=o[1],v=t.useState(null),p=v[0],y=v[1],b=t.useRef(null),m=t.useCallback(function(t,o){return void 0===o&&(o="POST"),r(u,void 0,void 0,function(){var u,s,v,p,m,w=this;return i(this,function(g){switch(g.label){case 0:f(!0),y(null),null===(p=b.current)||void 0===p||p.abort(),u=new AbortController,b.current=u,s=h(null!==(m=null==a?void 0:a.timeout)&&void 0!==m?m:1e4),v=function(u,f){return void 0===u&&(u=null!==(p=null==a?void 0:a.retry)&&void 0!==p?p:3),void 0===f&&(f=null!==(m=null==a?void 0:a.retryDelay)&&void 0!==m?m:500),r(w,void 0,void 0,function(){var r,h,p;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,c(e,{method:o,headers:n({"Content-Type":"application/json"},null==a?void 0:a.headers),body:JSON.stringify(t),cacheKey:null==a?void 0:a.cacheKey,signal:s})];case 1:return r=i.sent(),(null==a?void 0:a.optimisticUpdate)&&a.cacheKey&&(l.setData(a.cacheKey,function(e){return a.optimisticUpdate(e,r)}),l.invalidate(a.cacheKey)),null===(p=null==a?void 0:a.onSuccess)||void 0===p||p.call(a,r),[2,r];case 2:if("AbortError"===(h=i.sent()).name)throw h;return[2,d(function(){return v(u-1,2*f)},u-1,2*f)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,v()];case 2:return[2,g.sent()];case 3:return f(!1),[7];case 4:return[2]}})})},[e,a]),w=t.useCallback(function(){var e;return null===(e=b.current)||void 0===e?void 0:e.abort()},[]);return{mutate:m,loading:s,error:p,cancel:w}},e.useQuery=function(e,t){return p(e,t)},Object.defineProperty(e,"__esModule",{value:!0})});
