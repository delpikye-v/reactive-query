import{useState as e,useRef as t,useMemo as n,useCallback as r,useEffect as i}from"react";var o=function(){return o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},o.apply(this,arguments)};function u(e,t,n,r){return new(n||(n=Promise))(function(i,o){function u(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(u,a)}c((r=r.apply(e,t||[])).next())})}function a(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},u=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return u.next=a(0),u.throw=a(1),u.return=a(2),"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;u&&(u=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}"function"==typeof SuppressedError&&SuppressedError;var c=new Map,l={register:function(e,t,n,r,i){c.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=c.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t,n){var r,i=c.get(e);i&&(i.cache=t,(null==n?void 0:n.skip)||null===(r=i.setData)||void 0===r||r.call(i,function(){return t}))},setData:function(e,t,n){var r,i=c.get(e);if(i){var o=t(i.cache);i.cache=o,(null==n?void 0:n.skip)||null===(r=i.setData)||void 0===r||r.call(i,function(){return o})}},cancel:function(e){var t,n;null===(n=null===(t=c.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;if(e)null===(t=c.get(e))||void 0===t||t.refetch();else{var n=Array.from(c.values()).map(function(e){return e.refetch()});Promise.allSettled(n).then(function(e){e.forEach(function(e){"rejected"===e.status&&console.error("Query invalidate failed",e.reason)})})}},unregister:function(e){var t,n;null===(n=null===(t=c.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),c.delete(e)}},s=new Map,f={set:function(e,t,n){var r=n?Date.now()+n:void 0;s.set(e,{data:t,expireAt:r})},get:function(e){var t=s.get(e);if(t){if(!(t.expireAt&&t.expireAt<Date.now()))return t.data;s.delete(e)}},delete:function(e){s.delete(e)},clear:function(){s.clear()}},h={};var v=new Map;function d(e,t){var n;return void 0===t&&(t={}),u(this,void 0,void 0,function(){var r,i,c,l,s,d,p,y,b=this;return a(this,function(m){if(i=o(o(o({},r=h),t),{headers:o(o({},r.headers),t.headers)}),(null===(n=r.interceptors)||void 0===n?void 0:n.onRequest)&&Object.assign(i,r.interceptors.onRequest(e,i)),c=i.cacheKey,!!c&&!i.autoFetch){if(l=f.get(c))return[2,l];if(v.has(c))return[2,v.get(c)]}return s=i.body,i.isGraphQL&&i.query?s=JSON.stringify({query:i.query,variables:i.variables||{},operationName:i.operationName}):s&&"object"==typeof s&&(s=JSON.stringify(s)),d=o({"Content-Type":"application/json"},i.headers),p={method:i.method||"POST",headers:d,body:s,signal:i.signal},y=fetch(i.baseURL?i.baseURL+e:e,p).then(function(e){return u(b,void 0,void 0,function(){var t,n,o,u,l,s;return a(this,function(a){switch(a.label){case 0:if(!e.ok)throw new Error("HTTP Error: ".concat(e.status," ").concat(e.statusText));return[4,e.json()];case 1:if(t=a.sent(),n=i.isGraphQL?t.data:t,i.isGraphQL&&(null===(l=t.errors)||void 0===l?void 0:l.length))throw o=t.errors.map(function(e){return e.message}).join("; "),new Error("GraphQL Error: ".concat(o));return u=(null===(s=r.interceptors)||void 0===s?void 0:s.onResponse)?r.interceptors.onResponse(n):n,c&&f.set(c,u,i.cacheTime),[2,u]}})})}).catch(function(e){var t,n;throw null===(n=null===(t=r.interceptors)||void 0===t?void 0:t.onError)||void 0===n||n.call(t,e),e}).finally(function(){return c&&v.delete(c)}),c&&v.set(c,y),[2,y]})})}var p=null;function y(e){p=e}function b(e,t,n){e().then(function(e){n.setData(t,function(){return e})}).catch(function(e){null==p||p(e)})}function m(e,t,n,r){return void 0===t&&(t=3),void 0===n&&(n=500),void 0===r&&(r=1e4),u(this,void 0,void 0,function(){var i,o,c,l=this;return a(this,function(s){return i=new AbortController,o=i.signal,r&&setTimeout(function(){return i.abort()},r),c=function(t){return u(l,void 0,void 0,function(){var r;return a(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,5]),[4,e(o)];case 1:return[2,i.sent()];case 2:if("AbortError"===(null==(r=i.sent())?void 0:r.name))throw r;return t>0?[4,new Promise(function(e){return setTimeout(e,n)})]:[3,4];case 3:return i.sent(),[2,c(t-1)];case 4:throw null==p||p(r),r;case 5:return[2]}})})},[2,c(t)]})})}function w(e,t,n){e&&(l.setData(e,function(e){return n?n(e,t):t}),l.invalidate(e))}function g(e,t){return u(this,void 0,void 0,function(){var n;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,d(e,o(o({},t),{isGraphQL:t.isGraphQL}))];case 1:return[2,r.sent()];case 2:throw n=r.sent(),null==p||p(n,{endpoint:e}),n;case 3:return[2]}})})}function T(e,t){return void 0===t&&(t={}),u(this,void 0,void 0,function(){var n;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,d(e,o(o({},t),{isGraphQL:!!t.query||t.isGraphQL}))];case 1:return[2,r.sent()];case 2:return n=r.sent(),null==p||p(n,{endpoint:e}),[2,null];case 3:return[2]}})})}var K=new Map;function S(e,t){var n,r,i;return u(this,void 0,void 0,function(){var u,c,s,f;return a(this,function(a){if(u=t.cacheKey){if(c=l.getCache(u))return[2,c];if(s=function(e){return K.get(e)}(u),s)return[2,s]}return f=m(function(n){return g(e,o(o({},t),{signal:n,isGraphQL:!!t.query}))},null!==(n=t.retry)&&void 0!==n?n:0,null!==(r=t.retryDelay)&&void 0!==r?r:500,null!==(i=t.timeout)&&void 0!==i?i:1e4).then(function(e){return u&&l.setData(u,function(){return e},{skip:!0}),e}).finally(function(){u&&function(e){K.delete(e)}(u)}),u&&function(e,t){K.set(e,t)}(u,f),[2,f]})})}var E={fetchQuery:S,getQueryData:function(e){return l.getCache(e)},setQueryData:function(e,t){l.setData(e,t)},invalidateQueries:function(e){l.invalidate(e)},ensureQueryData:function(e,t){return u(this,void 0,void 0,function(){var n;return a(this,function(r){return(null==t?void 0:t.cacheKey)&&(n=l.getCache(t.cacheKey))?[2,n]:[2,S(e,t)]})})}},D=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function Q(o,c){var l=this,s=c.query,f=c.variables,h=c.options,v=e(null),d=v[0],p=v[1],y=e(null),b=y[0],T=y[1],K=e(!1),S=K[0],E=K[1],Q=t(null),A=t(!1),O=n(function(){return h||{}},[JSON.stringify(h)]),U=r(function(){return u(l,void 0,void 0,function(){var e,t,n,r,i,u,c,l,h;return a(this,function(a){switch(a.label){case 0:null===(r=Q.current)||void 0===r||r.abort(),e=new AbortController,Q.current=e,E(!0),T(null),a.label=1;case 1:return a.trys.push([1,3,4,5]),[4,m(function(e){var t;return g(o,{query:s,variables:f,body:s?JSON.stringify({query:s,variables:f}):void 0,headers:O.headers,method:s?"POST":null!==(t=O.method)&&void 0!==t?t:"GET",signal:e,cacheKey:O.cacheKey,cacheTime:O.cacheTime,staleTime:O.staleTime,operationName:O.operationName,isGraphQL:!!s})},null!==(i=O.retry)&&void 0!==i?i:0,null!==(u=O.retryDelay)&&void 0!==u?u:500,null!==(c=O.timeout)&&void 0!==c?c:1e4)];case 2:return t=a.sent(),O.optimisticUpdate&&O.cacheKey&&w(O.cacheKey,t,O.optimisticUpdate),p(t),null===(l=O.onSuccess)||void 0===l||l.call(O,t),[2,t];case 3:if("AbortError"===(n=a.sent()).name)throw n;throw T(n),null===(h=O.onError)||void 0===h||h.call(O,n),n;case 4:return E(!1),[7];case 5:return[2]}})})},[o,s,f,O]),k=r(function(){return u(l,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,U()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}})})},[U]),q=r(function(){var e;return null===(e=Q.current)||void 0===e?void 0:e.abort()},[]);return i(function(){return O.autoFetch&&!A.current&&(A.current=!0,k()),function(){return q()}},[]),i(function(){if(O.staleTime){var e=setInterval(function(){return k().catch(function(){})},O.staleTime);return function(){return clearInterval(e)}}},[O.staleTime,k]),i(function(){if(O.subscriptionUrl){var e=new D(O.subscriptionUrl).subscribe(function(e){p(function(t){return O.optimisticUpdate?O.optimisticUpdate(t,e):e}),O.cacheKey&&w(O.cacheKey,e,O.optimisticUpdate)});return function(){return e()}}},[O.subscriptionUrl,O.optimisticUpdate,O.cacheKey]),{data:d,error:b,loading:S,refetch:k,refetchAsync:U,mutate:p,cancel:q}}function A(e,t){return Q(e,{options:t})}function O(n,i){var o=this,c=e(!1),l=c[0],s=c[1],f=e(null),h=f[0],v=f[1],d=t(null),p=r(function(e,t){return void 0===t&&(t="POST"),u(o,void 0,void 0,function(){var r,o,u,c,l,f,h,p,y;return a(this,function(a){switch(a.label){case 0:null===(c=d.current)||void 0===c||c.abort(),r=new AbortController,d.current=r,s(!0),v(null),a.label=1;case 1:return a.trys.push([1,3,4,5]),[4,m(function(r){return g(n,{method:t,headers:null==i?void 0:i.headers,body:e,signal:r,cacheKey:null==i?void 0:i.cacheKey,cacheTime:null==i?void 0:i.cacheTime})},null!==(l=null==i?void 0:i.retry)&&void 0!==l?l:0,null!==(f=null==i?void 0:i.retryDelay)&&void 0!==f?f:500,null!==(h=null==i?void 0:i.timeout)&&void 0!==h?h:1e4)];case 2:return o=a.sent(),(null==i?void 0:i.optimisticUpdate)&&i.cacheKey&&w(i.cacheKey,o,i.optimisticUpdate),null===(p=null==i?void 0:i.onSuccess)||void 0===p||p.call(i,o),[2,o];case 3:if("AbortError"===(u=a.sent()).name)throw u;throw null===(y=null==i?void 0:i.onError)||void 0===y||y.call(i,u),v(u),u;case 4:return s(!1),[7];case 5:return[2]}})})},[n,i]),y=r(function(e,t){return u(o,void 0,void 0,function(){return a(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,p(e,t)];case 1:return[2,n.sent()];case 2:return n.sent(),[2,null];case 3:return[2]}})})},[p]),b=r(function(){var e;null===(e=d.current)||void 0===e||e.abort(),s(!1)},[]);return{mutate:y,mutateAsync:p,loading:l,error:h,cancel:b}}function U(e,t){return Q(e,{query:t.query,variables:t.variables,options:t})}function k(n,i){var o=this,c=e(!1),l=c[0],s=c[1],f=e(null),h=f[0],v=f[1],d=t(null),p=r(function(){return u(o,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,y()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}})})},[n,i]),y=r(function(){return u(o,void 0,void 0,function(){var e,t,r,o,u,c,l,f,h;return a(this,function(a){switch(a.label){case 0:null===(o=d.current)||void 0===o||o.abort(),e=new AbortController,d.current=e,s(!0),v(null),a.label=1;case 1:return a.trys.push([1,3,4,5]),[4,m(function(e){return g(n,{query:i.mutation,variables:i.variables,headers:i.headers,method:"POST",signal:e,cacheKey:i.cacheKey,cacheTime:i.cacheTime,operationName:i.operationName,isGraphQL:!0})},null!==(u=i.retry)&&void 0!==u?u:0,null!==(c=i.retryDelay)&&void 0!==c?c:500,null!==(l=i.timeout)&&void 0!==l?l:1e4)];case 2:return t=a.sent(),i.optimisticUpdate&&i.cacheKey&&w(i.cacheKey,t,i.optimisticUpdate),null===(f=i.onSuccess)||void 0===f||f.call(i,t),[2,t];case 3:if("AbortError"===(r=a.sent()).name)throw r;throw null===(h=i.onError)||void 0===h||h.call(i,r),v(r),r;case 4:return s(!1),[7];case 5:return[2]}})})},[n,i]),b=r(function(){var e;null===(e=d.current)||void 0===e||e.abort(),s(!1)},[]);return{mutate:p,mutateAsync:y,loading:l,error:h,cancel:b}}function q(e){f.delete(e)}function G(){f.clear()}function L(e){return void 0!==f.get(e)}export{D as SubscriptionManager,w as applyOptimisticUpdate,f as cache,G as clearAllCache,g as commonFetch,S as fetchQuery,m as fetchWithRetry,L as hasCache,q as invalidateCache,b as prefetchData,T as prefetchQuery,E as queryClient,l as queryRegistry,y as setGlobalErrorHandler,k as useGraphQLMutation,U as useGraphQLQuery,Q as useHybridQuery,O as useMutation,A as useQuery};
