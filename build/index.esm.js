import{useState as e,useRef as t,useCallback as n,useEffect as r}from"react";var i=function(){return i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i.apply(this,arguments)};function o(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function c(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,c)}u((r=r.apply(e,t||[])).next())})}function a(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=c(0),a.throw=c(1),a.return=c(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}}"function"==typeof SuppressedError&&SuppressedError;var c=[];function u(e,t){c.find(function(t){return t.name===e})||c.push({name:e,fn:t})}function s(e){var t=c.findIndex(function(t){return t.name===e});t>=0&&c.splice(t,1)}function l(e,t,n,r){return o(this,void 0,void 0,function(){var i,o,u;return a(this,function(a){switch(a.label){case 0:i={endpoint:e,body:t,method:n,options:r},o=0,u=c,a.label=1;case 1:return o<u.length?[4,u[o].fn(i)]:[3,4];case 2:i=a.sent(),a.label=3;case 3:return o++,[3,1];case 4:return[2,i]}})})}var d=new Map,h={get:function(e){var t=d.get(e);if(t)return t.data},set:function(e,t){d.set(e,{data:t,timestamp:Date.now()})},delete:function(e){d.delete(e)},clear:function(){return d.clear()}},f=new Map;function v(e,t){return void 0===t&&(t={}),o(this,void 0,void 0,function(){var n,r,i,c=this;return a(this,function(u){return n=t.cacheKey||e,f.has(n)?[2,f.get(n)]:(r=h.get(n))?[2,r]:(i=fetch(e,t).then(function(e){return o(c,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:return t=r.sent(),h.set(n,t),[2,t]}})})}).finally(function(){return f.delete(n)}),f.set(n,i),[2,i])})})}var p=new Map,y={register:function(e,t,n,r,i){p.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=p.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t){var n,r=p.get(e);r&&(r.cache=t,null===(n=r.setData)||void 0===n||n.call(r,function(){return t}))},setData:function(e,t){var n,r=p.get(e);if(r){var i=t(r.cache);r.cache=i,null===(n=r.setData)||void 0===n||n.call(r,function(){return i})}},cancel:function(e){var t,n;null===(n=null===(t=p.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;e?null===(t=p.get(e))||void 0===t||t.refetch():p.forEach(function(e){return e.refetch()})},unregister:function(e){var t,n;null===(n=null===(t=p.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),p.delete(e)}},b=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function m(e,t,n){return o(this,void 0,void 0,function(){var r;return a(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,4]),[4,e()];case 1:return[2,i.sent()];case 2:if(r=i.sent(),t<=0)throw r;return[4,new Promise(function(e){return setTimeout(e,n)})];case 3:return i.sent(),[2,m(e,t-1,n)];case 4:return[2]}})})}function w(e){var t=new AbortController;return setTimeout(function(){return t.abort()},e),t.signal}function g(e,t,n){e&&(y.setData(e,function(e){return t?t(e,n):n}),y.invalidate(e))}function K(c,u){var s=this,l=u.query,d=u.variables,h=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(u,["query","variables"]),f=e(null),v=f[0],p=f[1],K=e(null),T=K[0],D=K[1],U=e(!1),j=U[0],k=U[1],C=t(null),E=n(function(){return o(s,void 0,void 0,function(){var e,t,n,r,u,s=this;return a(this,function(f){switch(f.label){case 0:k(!0),D(null),null===(r=C.current)||void 0===r||r.abort(),e=new AbortController,C.current=e,t=w(null!==(u=h.timeout)&&void 0!==u?u:1e4),n=function(e,f){return void 0===e&&(e=null!==(r=h.retry)&&void 0!==r?r:3),void 0===f&&(f=null!==(u=h.retryDelay)&&void 0!==u?u:500),o(s,void 0,void 0,function(){var r,o;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,O(c,i(i({query:l,variables:d},h),{signal:t}))];case 1:return r=a.sent(),p(function(e){return h.optimisticUpdate?h.optimisticUpdate(e,r):r}),g(h.cacheKey,h.optimisticUpdate,r),[2,r];case 2:if("AbortError"===(o=a.sent()).name)throw o;return[2,m(function(){return n(e-1,2*f)},e-1,2*f)];case 3:return[2]}})})},f.label=1;case 1:return f.trys.push([1,,3,4]),[4,n()];case 2:return[2,f.sent()];case 3:return k(!1),[7];case 4:return[2]}})})},[c,l,d,h.cacheKey,h.headers,h.method,h.timeout,h.retry,h.retryDelay,h.optimisticUpdate]),q=n(function(){var e;null===(e=C.current)||void 0===e||e.abort()},[]);return r(function(){var e=!0;return o(s,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return h.prefetch&&h.cacheKey?(t=y.getCache(h.cacheKey))?(p(t),[3,3]):[3,1]:[3,3];case 1:return[4,S(c,i({query:l,variables:d},h))];case 2:n.sent(),n.label=3;case 3:return h.autoFetch&&e&&E(),[2]}})}),h.cacheKey&&y.register(h.cacheKey,E,p,q),function(){e=!1,q(),h.cacheKey&&y.unregister(h.cacheKey)}},[c,l,d,h.prefetch,h.autoFetch,h.cacheKey]),r(function(){if(h.staleTime){var e=setInterval(E,h.staleTime);return function(){return clearInterval(e)}}},[E,h.staleTime]),r(function(){if(h.subscriptionUrl){var e=new b(h.subscriptionUrl).subscribe(function(e){p(function(t){return h.optimisticUpdate?h.optimisticUpdate(t,e):e}),g(h.cacheKey,h.optimisticUpdate,e)});return function(){return e()}}},[h.subscriptionUrl]),{data:v,error:T,loading:j,refetch:E,setData:p,cancel:q}}function O(e,t){var n;return o(this,void 0,void 0,function(){var r,o,c,u,s;return a(this,function(a){switch(a.label){case 0:return r=null!==(n=t.method)&&void 0!==n?n:t.query?"POST":"GET",[4,l(e,t.query?{query:t.query,variables:t.variables}:void 0,r,{headers:t.headers,cacheKey:t.cacheKey,signal:t.signal})];case 1:return o=a.sent(),c=o.body,u=o.method,s=o.options,t.query?[4,v(e,{method:u,headers:i({"Content-Type":"application/json"},null==s?void 0:s.headers),body:JSON.stringify(c),cacheKey:null==s?void 0:s.cacheKey,signal:null==s?void 0:s.signal})]:[3,3];case 2:return[2,a.sent().data];case 3:return[2,v(e,{method:u,headers:null==s?void 0:s.headers,cacheKey:null==s?void 0:s.cacheKey,signal:null==s?void 0:s.signal})]}})})}function S(e,t){return o(this,void 0,void 0,function(){var n;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,O(e,t)];case 1:return n=r.sent(),t.cacheKey&&y.setCache(t.cacheKey,n),[2,n];case 2:return r.sent(),[2,null];case 3:return[2]}})})}function T(e,t){return K(e,t)}function D(r,c){var u=this,s=e(!1),d=s[0],h=s[1],f=e(null),p=f[0],b=f[1],g=t(null),K=n(function(e,t){return void 0===t&&(t="POST"),o(u,void 0,void 0,function(){var n,u,s,d,f,p=this;return a(this,function(K){switch(K.label){case 0:h(!0),b(null),null===(d=g.current)||void 0===d||d.abort(),n=new AbortController,g.current=n,u=w(null!==(f=null==c?void 0:c.timeout)&&void 0!==f?f:1e4),s=function(n,h){return void 0===n&&(n=null!==(d=null==c?void 0:c.retry)&&void 0!==d?d:3),void 0===h&&(h=null!==(f=null==c?void 0:c.retryDelay)&&void 0!==f?f:500),o(p,void 0,void 0,function(){var o,d,f,p,b,w,g,K;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,3,,4]),[4,l(r,e,t,{headers:null==c?void 0:c.headers,cacheKey:null==c?void 0:c.cacheKey,signal:u})];case 1:return o=a.sent(),[4,v(r,{method:o.method,headers:i({"Content-Type":"application/json"},null===(p=o.options)||void 0===p?void 0:p.headers),body:JSON.stringify(o.body),cacheKey:null===(b=o.options)||void 0===b?void 0:b.cacheKey,signal:null===(w=o.options)||void 0===w?void 0:w.signal})];case 2:return d=a.sent(),(null==c?void 0:c.optimisticUpdate)&&(null===(g=o.options)||void 0===g?void 0:g.cacheKey)&&(y.setData(o.options.cacheKey,function(e){return c.optimisticUpdate(e,d)}),y.invalidate(o.options.cacheKey)),null===(K=null==c?void 0:c.onSuccess)||void 0===K||K.call(c,d),[2,d];case 3:if("AbortError"===(f=a.sent()).name)throw f;return[2,m(function(){return s(n-1,2*h)},n-1,2*h)];case 4:return[2]}})})},K.label=1;case 1:return K.trys.push([1,,3,4]),[4,s()];case 2:return[2,K.sent()];case 3:return h(!1),[7];case 4:return[2]}})})},[r,c]),O=n(function(){var e;null===(e=g.current)||void 0===e||e.abort()},[]);return{mutate:K,loading:d,error:p,cancel:O}}function U(e,t){return K(e,t)}function j(e,r){var c=this,u=r.mutation,s=r.variables,d=r.cacheKey,h=r.optimisticUpdate,f=r.retry,p=void 0===f?3:f,b=r.retryDelay,g=void 0===b?500:b,K=r.timeout,O=void 0===K?1e4:K,S=t(null),T=n(function(){return o(c,void 0,void 0,function(){var t,n,c,f=this;return a(this,function(b){return null===(c=S.current)||void 0===c||c.abort(),S.current=new AbortController,t=w(O),n=function(c,p){return o(f,void 0,void 0,function(){var o,f,b,w,g,K;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,3,,4]),[4,l(e,{query:u,variables:s},"POST",{headers:r.headers,cacheKey:d,signal:t})];case 1:return o=a.sent(),[4,v(e,{method:o.method,headers:i({"Content-Type":"application/json"},null===(w=o.options)||void 0===w?void 0:w.headers),body:JSON.stringify(o.body),cacheKey:null===(g=o.options)||void 0===g?void 0:g.cacheKey,signal:null===(K=o.options)||void 0===K?void 0:K.signal})];case 2:return f=a.sent(),h&&d&&(y.setData(d,function(e){return h(e,f.data)}),y.invalidate(d)),[2,f.data];case 3:if("AbortError"===(b=a.sent()).name)throw b;return[2,m(function(){return n(c-1,2*p)},c-1,2*p)];case 4:return[2]}})})},[2,n(p,g)]})})},[e,u,s,d]),D=n(function(){var e;null===(e=S.current)||void 0===e||e.abort()},[]);return{mutate:T,cancel:D}}export{b as SubscriptionManager,h as cache,w as createTimeoutSignal,S as prefetchQuery,y as queryRegistry,s as removeMiddleware,m as retryOperation,l as runMiddlewares,g as updateCache,j as useGraphQLMutation,U as useGraphQLQuery,K as useHybridQuery,u as useMiddleware,D as useMutation,T as useQuery};
