import{useState as e,useRef as t,useMemo as n,useCallback as r,useEffect as i}from"react";var o=function(){return o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},o.apply(this,arguments)};function c(e,t,n,r){return new(n||(n=Promise))(function(i,o){function c(e){try{a(r.next(e))}catch(e){o(e)}}function u(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,u)}a((r=r.apply(e,t||[])).next())})}function u(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function u(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,u[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&u[0]?r.return:u[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,u[1])).done)return i;switch(r=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,r=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){o=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){o.label=u[1];break}if(6===u[0]&&o.label<i[1]){o.label=i[1],i=u;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(u);break}i[2]&&o.ops.pop(),o.trys.pop();continue}u=t.call(e,o)}catch(e){u=[6,e],r=0}finally{n=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}"function"==typeof SuppressedError&&SuppressedError;var a=new Map,l={register:function(e,t,n,r,i){a.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=a.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t,n){var r,i=a.get(e);i&&(i.cache=t,(null==n?void 0:n.skip)||null===(r=i.setData)||void 0===r||r.call(i,function(){return t}))},setData:function(e,t,n){var r,i=a.get(e);if(i){var o=t(i.cache);i.cache=o,(null==n?void 0:n.skip)||null===(r=i.setData)||void 0===r||r.call(i,function(){return o})}},cancel:function(e){var t,n;null===(n=null===(t=a.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;if(e)null===(t=a.get(e))||void 0===t||t.refetch();else{var n=Array.from(a.values()).map(function(e){return e.refetch()});Promise.allSettled(n).then(function(e){e.forEach(function(e){"rejected"===e.status&&console.error("Query invalidate failed",e.reason)})})}},unregister:function(e){var t,n;null===(n=null===(t=a.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),a.delete(e)}},s=new Map,f={set:function(e,t,n){var r=n?Date.now()+n:void 0;s.set(e,{data:t,expireAt:r})},get:function(e){var t=s.get(e);if(t){if(!(t.expireAt&&t.expireAt<Date.now()))return t.data;s.delete(e)}},delete:function(e){s.delete(e)},clear:function(){s.clear()}},h={};var d=new Map;function v(e,t){var n;return void 0===t&&(t={}),c(this,void 0,void 0,function(){var r,i,a,l,s,v,p,y,b=this;return u(this,function(m){if(i=o(o(o({},r=h),t),{headers:o(o({},r.headers),t.headers)}),(null===(n=r.interceptors)||void 0===n?void 0:n.onRequest)&&Object.assign(i,r.interceptors.onRequest(e,i)),a=i.cacheKey,!!a&&!i.autoFetch){if(l=f.get(a))return[2,l];if(d.has(a))return[2,d.get(a)]}return s=i.body,i.isGraphQL&&i.query?s=JSON.stringify({query:i.query,variables:i.variables||{},operationName:i.operationName}):s&&"object"==typeof s&&(s=JSON.stringify(s)),v=o({"Content-Type":"application/json"},i.headers),p={method:i.method||"POST",headers:v,body:s,signal:i.signal},y=fetch(i.baseURL?i.baseURL+e:e,p).then(function(e){return c(b,void 0,void 0,function(){var t,n,o,c,l,s;return u(this,function(u){switch(u.label){case 0:if(!e.ok)throw new Error("HTTP Error: ".concat(e.status," ").concat(e.statusText));return[4,e.json()];case 1:if(t=u.sent(),n=i.isGraphQL?t.data:t,i.isGraphQL&&(null===(l=t.errors)||void 0===l?void 0:l.length))throw o=t.errors.map(function(e){return e.message}).join("; "),new Error("GraphQL Error: ".concat(o));return c=(null===(s=r.interceptors)||void 0===s?void 0:s.onResponse)?r.interceptors.onResponse(n):n,a&&f.set(a,c,i.cacheTime),[2,c]}})})}).catch(function(e){var t,n;throw null===(n=null===(t=r.interceptors)||void 0===t?void 0:t.onError)||void 0===n||n.call(t,e),e}).finally(function(){return a&&d.delete(a)}),a&&d.set(a,y),[2,y]})})}var p=null;function y(e){p=e}function b(e,t,n){e().then(function(e){n.setData(t,function(){return e})}).catch(function(e){null==p||p(e)})}function m(e,t,n,r){return void 0===t&&(t=3),void 0===n&&(n=500),void 0===r&&(r=1e4),c(this,void 0,void 0,function(){var i,o,a,l=this;return u(this,function(s){return i=new AbortController,o=i.signal,r&&setTimeout(function(){return i.abort()},r),a=function(t){return c(l,void 0,void 0,function(){var r;return u(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,5]),[4,e(o)];case 1:return[2,i.sent()];case 2:if("AbortError"===(null==(r=i.sent())?void 0:r.name))throw r;return t>0?[4,new Promise(function(e){return setTimeout(e,n)})]:[3,4];case 3:return i.sent(),[2,a(t-1)];case 4:throw null==p||p(r),r;case 5:return[2]}})})},[2,a(t)]})})}function w(e,t,n){e&&(l.setData(e,function(e){return n?n(e,t):t}),l.invalidate(e))}function g(e,t){return c(this,void 0,void 0,function(){var n;return u(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,v(e,o(o({},t),{isGraphQL:t.isGraphQL}))];case 1:return[2,r.sent()];case 2:throw n=r.sent(),null==p||p(n,{endpoint:e}),n;case 3:return[2]}})})}function T(e,t){return void 0===t&&(t={}),c(this,void 0,void 0,function(){var n;return u(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,v(e,o(o({},t),{isGraphQL:!!t.query||t.isGraphQL}))];case 1:return[2,r.sent()];case 2:return n=r.sent(),null==p||p(n,{endpoint:e}),[2,null];case 3:return[2]}})})}var S=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function E(o,a){var l=this,s=a.query,f=a.variables,h=a.options,d=e(null),v=d[0],p=d[1],y=e(null),b=y[0],T=y[1],E=e(!1),K=E[0],A=E[1],O=t(null),U=t(!1),k=n(function(){return h||{}},[JSON.stringify(h)]),q=r(function(){return c(l,void 0,void 0,function(){var e,t,n,r,i,c,a,l,h;return u(this,function(u){switch(u.label){case 0:null===(r=O.current)||void 0===r||r.abort(),e=new AbortController,O.current=e,A(!0),T(null),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,m(function(e){var t;return g(o,{query:s,variables:f,body:s?JSON.stringify({query:s,variables:f}):void 0,headers:k.headers,method:s?"POST":null!==(t=k.method)&&void 0!==t?t:"GET",signal:e,cacheKey:k.cacheKey,cacheTime:k.cacheTime,staleTime:k.staleTime,operationName:k.operationName,isGraphQL:!!s})},null!==(i=k.retry)&&void 0!==i?i:0,null!==(c=k.retryDelay)&&void 0!==c?c:500,null!==(a=k.timeout)&&void 0!==a?a:1e4)];case 2:return t=u.sent(),k.optimisticUpdate&&k.cacheKey&&w(k.cacheKey,t,k.optimisticUpdate),p(t),null===(l=k.onSuccess)||void 0===l||l.call(k,t),[2,t];case 3:if("AbortError"===(n=u.sent()).name)throw n;throw T(n),null===(h=k.onError)||void 0===h||h.call(k,n),n;case 4:return A(!1),[7];case 5:return[2]}})})},[o,s,f,k]),G=r(function(){return c(l,void 0,void 0,function(){return u(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,q()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}})})},[q]),L=r(function(){var e;return null===(e=O.current)||void 0===e?void 0:e.abort()},[]);return i(function(){return k.autoFetch&&!U.current&&(U.current=!0,G()),function(){return L()}},[]),i(function(){if(k.staleTime){var e=setInterval(function(){return G().catch(function(){})},k.staleTime);return function(){return clearInterval(e)}}},[k.staleTime,G]),i(function(){if(k.subscriptionUrl){var e=new S(k.subscriptionUrl).subscribe(function(e){p(function(t){return k.optimisticUpdate?k.optimisticUpdate(t,e):e}),k.cacheKey&&w(k.cacheKey,e,k.optimisticUpdate)});return function(){return e()}}},[k.subscriptionUrl,k.optimisticUpdate,k.cacheKey]),{data:v,error:b,loading:K,refetch:G,refetchAsync:q,mutate:p,cancel:L}}function K(e,t){return E(e,{options:t})}function A(n,i){var o=this,a=e(!1),l=a[0],s=a[1],f=e(null),h=f[0],d=f[1],v=t(null),p=r(function(e,t){return void 0===t&&(t="POST"),c(o,void 0,void 0,function(){var r,o,c,a,l,f,h,p,y;return u(this,function(u){switch(u.label){case 0:null===(a=v.current)||void 0===a||a.abort(),r=new AbortController,v.current=r,s(!0),d(null),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,m(function(r){return g(n,{method:t,headers:null==i?void 0:i.headers,body:e,signal:r,cacheKey:null==i?void 0:i.cacheKey,cacheTime:null==i?void 0:i.cacheTime})},null!==(l=null==i?void 0:i.retry)&&void 0!==l?l:0,null!==(f=null==i?void 0:i.retryDelay)&&void 0!==f?f:500,null!==(h=null==i?void 0:i.timeout)&&void 0!==h?h:1e4)];case 2:return o=u.sent(),(null==i?void 0:i.optimisticUpdate)&&i.cacheKey&&w(i.cacheKey,o,i.optimisticUpdate),null===(p=null==i?void 0:i.onSuccess)||void 0===p||p.call(i,o),[2,o];case 3:if("AbortError"===(c=u.sent()).name)throw c;throw null===(y=null==i?void 0:i.onError)||void 0===y||y.call(i,c),d(c),c;case 4:return s(!1),[7];case 5:return[2]}})})},[n,i]),y=r(function(e,t){return c(o,void 0,void 0,function(){return u(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,p(e,t)];case 1:return[2,n.sent()];case 2:return n.sent(),[2,null];case 3:return[2]}})})},[p]),b=r(function(){var e;null===(e=v.current)||void 0===e||e.abort(),s(!1)},[]);return{mutate:y,mutateAsync:p,loading:l,error:h,cancel:b}}function O(e,t){return E(e,{query:t.query,variables:t.variables,options:t})}function U(n,i){var o=this,a=e(!1),l=a[0],s=a[1],f=e(null),h=f[0],d=f[1],v=t(null),p=r(function(){return c(o,void 0,void 0,function(){return u(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,y()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}})})},[n,i]),y=r(function(){return c(o,void 0,void 0,function(){var e,t,r,o,c,a,l,f,h;return u(this,function(u){switch(u.label){case 0:null===(o=v.current)||void 0===o||o.abort(),e=new AbortController,v.current=e,s(!0),d(null),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,m(function(e){return g(n,{query:i.mutation,variables:i.variables,headers:i.headers,method:"POST",signal:e,cacheKey:i.cacheKey,cacheTime:i.cacheTime,operationName:i.operationName,isGraphQL:!0})},null!==(c=i.retry)&&void 0!==c?c:0,null!==(a=i.retryDelay)&&void 0!==a?a:500,null!==(l=i.timeout)&&void 0!==l?l:1e4)];case 2:return t=u.sent(),i.optimisticUpdate&&i.cacheKey&&w(i.cacheKey,t,i.optimisticUpdate),null===(f=i.onSuccess)||void 0===f||f.call(i,t),[2,t];case 3:if("AbortError"===(r=u.sent()).name)throw r;throw null===(h=i.onError)||void 0===h||h.call(i,r),d(r),r;case 4:return s(!1),[7];case 5:return[2]}})})},[n,i]),b=r(function(){var e;null===(e=v.current)||void 0===e||e.abort(),s(!1)},[]);return{mutate:p,mutateAsync:y,loading:l,error:h,cancel:b}}function k(e){f.delete(e)}function q(){f.clear()}function G(e){return void 0!==f.get(e)}export{S as SubscriptionManager,w as applyOptimisticUpdate,f as cache,q as clearAllCache,g as commonFetch,m as fetchWithRetry,G as hasCache,k as invalidateCache,b as prefetchData,T as prefetchQuery,l as queryRegistry,y as setGlobalErrorHandler,U as useGraphQLMutation,O as useGraphQLQuery,E as useHybridQuery,A as useMutation,K as useQuery};
