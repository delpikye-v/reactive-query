import{useState as t,useRef as e,useCallback as n,useEffect as r}from"react";var i=function(){return i=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},i.apply(this,arguments)};function a(t,e,n,r){return new(n||(n=Promise))(function(i,a){function o(t){try{u(r.next(t))}catch(t){a(t)}}function c(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,c)}u((r=r.apply(t,e||[])).next())})}function o(t,e){var n,r,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=c(0),o.throw=c(1),o.return=c(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){a.label=c[1];break}if(6===c[0]&&a.label<i[1]){a.label=i[1],i=c;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(c);break}i[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}}"function"==typeof SuppressedError&&SuppressedError;var c=new Map,u={get:function(t){var e=c.get(t);if(e)return e.data},set:function(t,e){c.set(t,{data:e,timestamp:Date.now()})},delete:function(t){c.delete(t)},clear:function(){return c.clear()}},s=new Map;function l(t,e){return void 0===e&&(e={}),a(this,void 0,void 0,function(){var n,r,i,c=this;return o(this,function(l){return n=e.cacheKey||t,s.has(n)?[2,s.get(n)]:(r=u.get(n))?[2,r]:(i=fetch(t,e).then(function(t){return a(c,void 0,void 0,function(){var e;return o(this,function(r){switch(r.label){case 0:if(!t.ok)throw new Error(t.statusText);return[4,t.json()];case 1:return e=r.sent(),u.set(n,e),[2,e]}})})}).finally(function(){return s.delete(n)}),s.set(n,i),[2,i])})})}var f=new Map,d={register:function(t,e,n,r){f.set(t,{cacheKey:t,refetch:e,setData:n,cancel:r})},setData:function(t,e){var n=f.get(t);(null==n?void 0:n.setData)&&n.setData(e)},cancel:function(t){var e,n=f.get(t);null===(e=null==n?void 0:n.cancel)||void 0===e||e.call(n)},invalidate:function(t){var e;t?null===(e=f.get(t))||void 0===e||e.refetch():f.forEach(function(t){return t.refetch()})},unregister:function(t){var e,n;null===(n=null===(e=f.get(t))||void 0===e?void 0:e.cancel)||void 0===n||n.call(e),f.delete(t)}},h=function(){function t(t){this.url=t,this.callbacks=new Set,this.ws=null}return t.prototype.connect=function(){var t=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(e){var n=JSON.parse(e.data);t.callbacks.forEach(function(t){return t(n)})})},t.prototype.subscribe=function(t){var e=this;return this.callbacks.add(t),this.connect(),function(){return e.callbacks.delete(t)}},t.prototype.disconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close(),this.ws=null,this.callbacks.clear()},t}();function v(t,e,n){return a(this,void 0,void 0,function(){var r;return o(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,4]),[4,t()];case 1:return[2,i.sent()];case 2:if(r=i.sent(),e<=0)throw r;return[4,new Promise(function(t){return setTimeout(t,n)})];case 3:return i.sent(),[2,v(t,e-1,2*n)];case 4:return[2]}})})}function p(t){var e=new AbortController,n=setTimeout(function(){return e.abort()},t);return e.signal.addEventListener("abort",function(){return clearTimeout(n)}),e.signal}function y(t,e,n){t&&(d.setData(t,function(t){return e?e(t,n):n}),d.invalidate(t))}function b(c,u){var s=this,f=u.query,b=u.variables,m=u.options,w=void 0===m?{}:m,g=t(null),K=g[0],T=g[1],U=t(null),D=U[0],S=U[1],O=t(!1),k=O[0],E=O[1],j=e(null),x=n(function(){return a(s,void 0,void 0,function(){var t,e,n,r,u,s=this;return o(this,function(d){switch(d.label){case 0:E(!0),S(null),null===(r=j.current)||void 0===r||r.abort(),t=new AbortController,j.current=t,e=p(null!==(u=w.timeout)&&void 0!==u?u:1e4),n=function(t,d){return void 0===t&&(t=null!==(r=w.retry)&&void 0!==r?r:3),void 0===d&&(d=null!==(u=w.retryDelay)&&void 0!==u?u:500),a(s,void 0,void 0,function(){var r,a,u;return o(this,function(o){switch(o.label){case 0:return o.trys.push([0,5,,6]),f?[4,l(c,{method:"POST",headers:i({"Content-Type":"application/json"},w.headers),body:JSON.stringify({query:f,variables:b}),cacheKey:w.cacheKey,signal:e})]:[3,2];case 1:return a=o.sent(),r=a.data,[3,4];case 2:return[4,l(c,{cacheKey:w.cacheKey,signal:e,headers:w.headers})];case 3:r=o.sent(),o.label=4;case 4:return T(function(t){return w.optimisticUpdate?w.optimisticUpdate(t,r):r}),y(w.cacheKey,w.optimisticUpdate,r),[2,r];case 5:if("AbortError"===(u=o.sent()).name)throw u;return[2,v(function(){return n(t-1,2*d)},t-1,2*d)];case 6:return[2]}})})},d.label=1;case 1:return d.trys.push([1,,3,4]),[4,n()];case 2:return[2,d.sent()];case 3:return E(!1),[7];case 4:return[2]}})})},[c,f,b,w.cacheKey,w.optimisticUpdate,w.retry,w.retryDelay,w.headers,w.timeout]),A=n(function(){var t;return null===(t=j.current)||void 0===t?void 0:t.abort()},[]);return r(function(){return w.cacheKey&&d.register(w.cacheKey,x,T,A),function(){w.cacheKey&&d.unregister(w.cacheKey),A()}},[w.cacheKey,x,T,A]),r(function(){if(w.staleTime){var t=setInterval(x,w.staleTime);return function(){return clearInterval(t)}}},[x,w.staleTime]),r(function(){if(w.subscriptionUrl){var t=new h(w.subscriptionUrl).subscribe(function(t){T(function(e){return w.optimisticUpdate?w.optimisticUpdate(e,t):t}),y(w.cacheKey,w.optimisticUpdate,t)});return function(){return t()}}},[w.subscriptionUrl,w.optimisticUpdate,w.cacheKey]),{data:K,error:D,loading:k,refetch:x,mutate:T,cancel:A}}function m(t,e){return b(t,e)}function w(r,c){var u=this,s=t(!1),f=s[0],h=s[1],y=t(null),b=y[0],m=y[1],w=e(null),g=n(function(t,e){return void 0===e&&(e="POST"),a(u,void 0,void 0,function(){var n,u,s,f,y,b=this;return o(this,function(g){switch(g.label){case 0:h(!0),m(null),null===(f=w.current)||void 0===f||f.abort(),n=new AbortController,w.current=n,u=p(null!==(y=null==c?void 0:c.timeout)&&void 0!==y?y:1e4),s=function(n,h){return void 0===n&&(n=null!==(f=null==c?void 0:c.retry)&&void 0!==f?f:3),void 0===h&&(h=null!==(y=null==c?void 0:c.retryDelay)&&void 0!==y?y:500),a(b,void 0,void 0,function(){var a,f,p;return o(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,l(r,{method:e,headers:i({"Content-Type":"application/json"},null==c?void 0:c.headers),body:JSON.stringify(t),cacheKey:null==c?void 0:c.cacheKey,signal:u})];case 1:return a=o.sent(),(null==c?void 0:c.optimisticUpdate)&&c.cacheKey&&(d.setData(c.cacheKey,function(t){return c.optimisticUpdate(t,a)}),d.invalidate(c.cacheKey)),null===(p=null==c?void 0:c.onSuccess)||void 0===p||p.call(c,a),[2,a];case 2:if("AbortError"===(f=o.sent()).name)throw f;return[2,v(function(){return s(n-1,2*h)},n-1,2*h)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,s()];case 2:return[2,g.sent()];case 3:return h(!1),[7];case 4:return[2]}})})},[r,c]),K=n(function(){var t;return null===(t=w.current)||void 0===t?void 0:t.abort()},[]);return{mutate:g,loading:f,error:b,cancel:K}}function g(t,e){return b(t,{query:e.query,variables:e.variables,options:{cacheKey:e.cacheKey,staleTime:e.staleTime,headers:e.headers,timeout:e.timeout,retry:e.retry,retryDelay:e.retryDelay,optimisticUpdate:e.optimisticUpdate}})}function K(t,r){var c=this,u=r.mutation,s=r.variables,f=r.cacheKey,h=r.optimisticUpdate,y=r.retry,b=void 0===y?3:y,m=r.retryDelay,w=void 0===m?500:m,g=r.headers,K=r.timeout,T=void 0===K?1e4:K,U=e(null),D=n(function(){return a(c,void 0,void 0,function(){var e,n,r,c,y=this;return o(this,function(m){switch(m.label){case 0:null===(c=U.current)||void 0===c||c.abort(),e=new AbortController,U.current=e,n=p(T),r=function(e,c){return a(y,void 0,void 0,function(){var a,p;return o(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,l(t,{method:"POST",headers:i({"Content-Type":"application/json"},g),body:JSON.stringify({query:u,variables:s}),signal:n,cacheKey:f})];case 1:return a=o.sent(),h&&f&&d.setData(f,function(t){return h(t,a.data)}),f&&d.invalidate(f),[2,a.data];case 2:if("AbortError"===(p=o.sent()).name)throw p;return[2,v(function(){return r(e-1,2*c)},e-1,2*c)];case 3:return[2]}})})},m.label=1;case 1:return m.trys.push([1,,3,4]),[4,r(b,w)];case 2:return[2,m.sent()];case 3:return[7];case 4:return[2]}})})},[t,u,s,f,h,b,w,g,T]),S=n(function(){var t;null===(t=U.current)||void 0===t||t.abort()},[]);return{mutate:D,cancel:S}}export{h as SubscriptionManager,u as cache,p as createTimeoutSignal,d as queryRegistry,v as retryOperation,y as updateCache,K as useGraphQLMutation,g as useGraphQLQuery,b as useHybridQuery,w as useMutation,m as useQuery};
