import{useState as e,useRef as t,useMemo as n,useCallback as r,useEffect as i}from"react";var o=function(){return o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},o.apply(this,arguments)};function c(e,t,n,r){return new(n||(n=Promise))(function(i,o){function c(e){try{a(r.next(e))}catch(e){o(e)}}function u(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,u)}a((r=r.apply(e,t||[])).next())})}function u(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function u(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,u[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&u[0]?r.return:u[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,u[1])).done)return i;switch(r=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,r=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){o=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){o.label=u[1];break}if(6===u[0]&&o.label<i[1]){o.label=i[1],i=u;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(u);break}i[2]&&o.ops.pop(),o.trys.pop();continue}u=t.call(e,o)}catch(e){u=[6,e],r=0}finally{n=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}"function"==typeof SuppressedError&&SuppressedError;var a=new Map,l={register:function(e,t,n,r,i){a.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=a.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t,n){var r,i=a.get(e);i&&(i.cache=t,(null==n?void 0:n.skip)||null===(r=i.setData)||void 0===r||r.call(i,function(){return t}))},setData:function(e,t,n){var r,i=a.get(e);if(i){var o=t(i.cache);i.cache=o,(null==n?void 0:n.skip)||null===(r=i.setData)||void 0===r||r.call(i,function(){return o})}},cancel:function(e){var t,n;null===(n=null===(t=a.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;e?null===(t=a.get(e))||void 0===t||t.refetch():a.forEach(function(e){return e.refetch()})},unregister:function(e){var t,n;null===(n=null===(t=a.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),a.delete(e)}},s=new Map,f={set:function(e,t,n){var r=n?Date.now()+n:void 0;s.set(e,{data:t,expireAt:r})},get:function(e){var t=s.get(e);if(t){if(!(t.expireAt&&t.expireAt<Date.now()))return t.data;s.delete(e)}},delete:function(e){s.delete(e)},clear:function(){s.clear()}},h={};var v=new Map;function d(e,t){var n;return void 0===t&&(t={}),c(this,void 0,void 0,function(){var r,i,a,l,s,d=this;return u(this,function(p){if(i=o(o(o({},r=h),t),{headers:o(o({},r.headers),t.headers)}),(null===(n=r.interceptors)||void 0===n?void 0:n.onRequest)&&(i=r.interceptors.onRequest(e,i)),a=i.cacheKey,!!a&&!i.staleTime&&!i.autoFetch){if(l=f.get(a))return[2,l];if(v.has(a))return[2,v.get(a)]}return s=fetch(i.baseURL?i.baseURL+e:e,i).then(function(e){return c(d,void 0,void 0,function(){var t,n,o,c,l;return u(this,function(u){switch(u.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:if(t=u.sent(),n=i.isGraphQL?t.data:t,i.isGraphQL&&(null===(c=t.errors)||void 0===c?void 0:c.length))throw new Error(t.errors[0].message);return o=(null===(l=r.interceptors)||void 0===l?void 0:l.onResponse)?r.interceptors.onResponse(n):n,a&&f.set(a,o,i.cacheTime),[2,o]}})})}).catch(function(e){var t,n;throw null===(n=null===(t=r.interceptors)||void 0===t?void 0:t.onError)||void 0===n||n.call(t,e),e}).finally(function(){return a&&v.delete(a)}),a&&v.set(a,s),[2,s]})})}var p=null;function b(e){p=e}function y(e,t,n){e().then(function(e){n.setData(t,function(){return e})}).catch(function(e){console.error("Prefetch error:",e),null==p||p(e)})}function w(e,t,n,r){return void 0===t&&(t=3),void 0===n&&(n=500),void 0===r&&(r=1e4),c(this,void 0,void 0,function(){var i,o,a,l=this;return u(this,function(s){return i=new AbortController,o=i.signal,r&&setTimeout(function(){return i.abort()},r),a=function(t){return c(l,void 0,void 0,function(){var r;return u(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,5]),[4,e(o)];case 1:return[2,i.sent()];case 2:if("AbortError"===(r=i.sent()).name)throw r;return t>0?[4,new Promise(function(e){return setTimeout(e,n)})]:[3,4];case 3:return i.sent(),[2,a(t-1)];case 4:throw null==p||p(r),r;case 5:return[2]}})})},[2,a(t)]})})}function m(e,t,n){e&&(l.setData(e,function(e){return n?n(e,t):t}),l.invalidate(e))}function g(e,t){return c(this,void 0,void 0,function(){var n;return u(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,d(e,o(o({},t),{isGraphQL:t.isGraphQL}))];case 1:return[2,r.sent()];case 2:throw n=r.sent(),null==p||p(n,{endpoint:e}),n;case 3:return[2]}})})}function T(e,t){return void 0===t&&(t={}),c(this,void 0,void 0,function(){var n;return u(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,d(e,o(o({},t),{isGraphQL:!!t.query||t.isGraphQL}))];case 1:return[2,r.sent()];case 2:return n=r.sent(),console.error("Prefetch failed",n),[2,null];case 3:return[2]}})})}var K=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function E(o,a){var l=this,s=a.query,f=a.variables,h=a.options,v=e(null),d=v[0],p=v[1],b=e(null),y=b[0],T=b[1],E=e(!1),S=E[0],U=E[1],k=t(null),A=t(!1),D=n(function(){return h||{}},[JSON.stringify(h)]),O=r(function(){return c(l,void 0,void 0,function(){var e,t,n,r,i,c,a,l,h;return u(this,function(u){switch(u.label){case 0:null===(r=k.current)||void 0===r||r.abort(),e=new AbortController,k.current=e,U(!0),T(null),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,w(function(e){var t;return g(o,{query:s,variables:f,body:s?JSON.stringify({query:s,variables:f}):void 0,headers:D.headers,method:s?"POST":null!==(t=D.method)&&void 0!==t?t:"GET",signal:e,cacheKey:D.cacheKey,cacheTime:D.cacheTime,staleTime:D.staleTime,isGraphQL:!!s})},null!==(i=D.retry)&&void 0!==i?i:0,null!==(c=D.retryDelay)&&void 0!==c?c:500,null!==(a=D.timeout)&&void 0!==a?a:1e4)];case 2:return t=u.sent(),D.optimisticUpdate&&D.cacheKey&&m(D.cacheKey,t,D.optimisticUpdate),p(t),null===(l=D.onSuccess)||void 0===l||l.call(D,t),[2,t];case 3:if("AbortError"===(n=u.sent()).name)return[2,null];throw T(n),null===(h=D.onError)||void 0===h||h.call(D,n),n;case 4:return U(!1),[7];case 5:return[2]}})})},[o,s,f,D]),x=r(function(){var e;null===(e=k.current)||void 0===e||e.abort()},[]);return i(function(){return D.autoFetch&&!A.current&&(A.current=!0,O()),function(){return x()}},[]),i(function(){if(D.staleTime){var e=setInterval(function(){return O()},D.staleTime);return function(){return clearInterval(e)}}},[O,D.staleTime]),i(function(){if(D.subscriptionUrl){var e=new K(D.subscriptionUrl).subscribe(function(e){p(function(t){return D.optimisticUpdate?D.optimisticUpdate(t,e):e}),D.cacheKey&&m(D.cacheKey,e,D.optimisticUpdate)});return function(){return e()}}},[D.subscriptionUrl,D.optimisticUpdate,D.cacheKey]),{data:d,error:y,loading:S,refetch:O,mutate:p,cancel:x}}function S(e,t){return E(e,{options:t})}function U(n,i){var o=this,a=e(!1),l=a[0],s=a[1],f=e(null),h=f[0],v=f[1],d=t(null),p=r(function(e,t){return void 0===t&&(t="POST"),c(o,void 0,void 0,function(){var r,o,c,a,l,f,h,p,b;return u(this,function(u){switch(u.label){case 0:null===(a=d.current)||void 0===a||a.abort(),r=new AbortController,d.current=r,s(!0),v(null),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,w(function(r){return g(n,{method:t,headers:null==i?void 0:i.headers,body:e,signal:r,cacheKey:null==i?void 0:i.cacheKey,cacheTime:null==i?void 0:i.cacheTime})},null!==(l=null==i?void 0:i.retry)&&void 0!==l?l:0,null!==(f=null==i?void 0:i.retryDelay)&&void 0!==f?f:500,null!==(h=null==i?void 0:i.timeout)&&void 0!==h?h:1e4)];case 2:return o=u.sent(),(null==i?void 0:i.optimisticUpdate)&&i.cacheKey&&m(i.cacheKey,o,i.optimisticUpdate),null===(p=null==i?void 0:i.onSuccess)||void 0===p||p.call(i,o),[2,o];case 3:if("AbortError"===(c=u.sent()).name)throw c;throw null===(b=null==i?void 0:i.onError)||void 0===b||b.call(i,c),v(c),c;case 4:return s(!1),[7];case 5:return[2]}})})},[n,i]),b=r(function(){var e;null===(e=d.current)||void 0===e||e.abort(),s(!1)},[]);return{mutate:p,loading:l,error:h,cancel:b}}function k(e,t){return E(e,{query:t.query,variables:t.variables,options:t})}function A(n,i){var o=this,a=e(!1),l=a[0],s=a[1],f=e(null),h=f[0],v=f[1],d=t(null),p=r(function(){return c(o,void 0,void 0,function(){var e,t,r,o,c,a,l,f,h;return u(this,function(u){switch(u.label){case 0:null===(o=d.current)||void 0===o||o.abort(),e=new AbortController,d.current=e,s(!0),v(null),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,w(function(e){return g(n,{query:i.mutation,variables:i.variables,headers:null==i?void 0:i.headers,method:"POST",signal:e,cacheKey:i.cacheKey,cacheTime:i.cacheTime,isGraphQL:!0})},null!==(c=i.retry)&&void 0!==c?c:0,null!==(a=i.retryDelay)&&void 0!==a?a:500,null!==(l=i.timeout)&&void 0!==l?l:1e4)];case 2:return t=u.sent(),i.optimisticUpdate&&i.cacheKey&&m(i.cacheKey,t,i.optimisticUpdate),null===(f=i.onSuccess)||void 0===f||f.call(i,t),[2,t];case 3:if("AbortError"===(r=u.sent()).name)throw r;throw null===(h=i.onError)||void 0===h||h.call(i,r),v(r),r;case 4:return s(!1),[7];case 5:return[2]}})})},[n,i]),b=r(function(){var e;null===(e=d.current)||void 0===e||e.abort(),s(!1)},[]);return{mutate:p,loading:l,error:h,cancel:b}}function D(e){f.delete(e)}function O(){f.clear()}function x(e){return void 0!==f.get(e)}export{K as SubscriptionManager,m as applyOptimisticUpdate,f as cache,O as clearAllCache,g as commonFetch,w as fetchWithRetry,x as hasCache,D as invalidateCache,y as prefetchData,T as prefetchQuery,l as queryRegistry,b as setGlobalErrorHandler,A as useGraphQLMutation,k as useGraphQLQuery,E as useHybridQuery,U as useMutation,S as useQuery};
