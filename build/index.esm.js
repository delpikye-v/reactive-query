import{useState as e,useRef as t,useCallback as n,useEffect as r}from"react";var i=function(){return i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i.apply(this,arguments)};function a(e,t,n,r){return new(n||(n=Promise))(function(i,a){function c(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,o)}u((r=r.apply(e,t||[])).next())})}function c(e,t){var n,r,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=o(0),c.throw=o(1),c.return=o(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function o(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,o[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}"function"==typeof SuppressedError&&SuppressedError;var o=new Map,u={get:function(e){var t=o.get(e);if(t)return t.data},set:function(e,t){o.set(e,{data:t,timestamp:Date.now()})},delete:function(e){o.delete(e)},clear:function(){return o.clear()}},s=new Map;function l(e,t){return void 0===t&&(t={}),a(this,void 0,void 0,function(){var n,r,i,o=this;return c(this,function(l){return n=t.cacheKey||e,s.has(n)?[2,s.get(n)]:(r=u.get(n))?[2,r]:(i=fetch(e,t).then(function(e){return a(o,void 0,void 0,function(){var t;return c(this,function(r){switch(r.label){case 0:if(!e.ok)throw new Error(e.statusText);return[4,e.json()];case 1:return t=r.sent(),u.set(n,t),[2,t]}})})}).finally(function(){return s.delete(n)}),s.set(n,i),[2,i])})})}var h=new Map,d={register:function(e,t,n,r,i){h.set(e,{cacheKey:e,refetch:t,setData:n,cancel:r,cache:i})},getCache:function(e){var t;return null===(t=h.get(e))||void 0===t?void 0:t.cache},setCache:function(e,t){var n,r=h.get(e);r&&(r.cache=t,null===(n=r.setData)||void 0===n||n.call(r,function(){return t}))},setData:function(e,t){var n,r=h.get(e);if(r){var i=t(r.cache);r.cache=i,null===(n=r.setData)||void 0===n||n.call(r,function(){return i})}},cancel:function(e){var t,n;null===(n=null===(t=h.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t)},invalidate:function(e){var t;e?null===(t=h.get(e))||void 0===t||t.refetch():h.forEach(function(e){return e.refetch()})},unregister:function(e){var t,n;null===(n=null===(t=h.get(e))||void 0===t?void 0:t.cancel)||void 0===n||n.call(t),h.delete(e)}},f=function(){function e(e){this.url=e,this.callbacks=new Set,this.ws=null}return e.prototype.connect=function(){var e=this;this.ws||(this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);e.callbacks.forEach(function(e){return e(n)})})},e.prototype.subscribe=function(e){var t=this;return this.callbacks.add(e),this.connect(),function(){return t.callbacks.delete(e)}},e.prototype.disconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(),this.ws=null,this.callbacks.clear()},e}();function v(e,t,n){return a(this,void 0,void 0,function(){var r;return c(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,4]),[4,e()];case 1:return[2,i.sent()];case 2:if(r=i.sent(),t<=0)throw r;return[4,new Promise(function(e){return setTimeout(e,n)})];case 3:return i.sent(),[2,v(e,t-1,2*n)];case 4:return[2]}})})}function y(e){var t=new AbortController,n=setTimeout(function(){return t.abort()},e);return t.signal.addEventListener("abort",function(){return clearTimeout(n)}),t.signal}function p(e,t,n){e&&(d.setData(e,function(e){return t?t(e,n):n}),d.invalidate(e))}function b(e,t,n,r,i,o){return a(this,void 0,void 0,function(){var a,u;return c(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,w(e,t,n,{headers:i,cacheKey:r,method:o})];case 1:return a=c.sent(),r&&d.setCache(r,a),[2,a];case 2:return u=c.sent(),console.error("Prefetch failed",u),[2,null];case 3:return[2]}})})}function m(i,o){var u=this,s=o.query,l=o.variables,h=o.options,m=void 0===h?{}:h,g=e(null),K=g[0],T=g[1],U=e(null),D=U[0],S=U[1],O=e(!1),k=O[0],C=O[1],E=t(null),j=n(function(){return a(u,void 0,void 0,function(){var e,t,n,r,o,u=this;return c(this,function(h){switch(h.label){case 0:C(!0),S(null),null===(r=E.current)||void 0===r||r.abort(),e=new AbortController,E.current=e,t=y(null!==(o=m.timeout)&&void 0!==o?o:1e4),n=function(e,h){return void 0===e&&(e=null!==(r=m.retry)&&void 0!==r?r:3),void 0===h&&(h=null!==(o=m.retryDelay)&&void 0!==o?o:500),a(u,void 0,void 0,function(){var r,a;return c(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,w(i,s,l,{headers:m.headers,cacheKey:m.cacheKey,method:m.method,signal:t})];case 1:return r=c.sent(),T(function(e){return m.optimisticUpdate?m.optimisticUpdate(e,r):r}),p(m.cacheKey,m.optimisticUpdate,r),[2,r];case 2:if("AbortError"===(a=c.sent()).name)throw a;return[2,v(function(){return n(e-1,2*h)},e-1,2*h)];case 3:return[2]}})})},h.label=1;case 1:return h.trys.push([1,,3,4]),[4,n()];case 2:return[2,h.sent()];case 3:return C(!1),[7];case 4:return[2]}})})},[i,s,l,m.cacheKey,m.optimisticUpdate,m.retry,m.retryDelay,m.headers,m.timeout,m.method]),x=n(function(){var e;return null===(e=E.current)||void 0===e?void 0:e.abort()},[]);return r(function(){var e=!0;return a(u,void 0,void 0,function(){var t;return c(this,function(n){switch(n.label){case 0:return m.prefetch&&m.cacheKey?(t=d.getCache(m.cacheKey))?(T(t),[3,3]):[3,1]:[3,3];case 1:return[4,b(i,s,l,m.cacheKey,m.headers,m.method)];case 2:n.sent(),n.label=3;case 3:return m.autoFetch&&e&&j(),[2]}})}),m.cacheKey&&d.register(m.cacheKey,j,T,x),function(){m.cacheKey&&d.unregister(m.cacheKey),x(),e=!1}},[i,s,l,m.prefetch,m.autoFetch,m.cacheKey,m.method]),r(function(){if(m.staleTime){var e=setInterval(j,m.staleTime);return function(){return clearInterval(e)}}},[j,m.staleTime]),r(function(){if(m.subscriptionUrl){var e=new f(m.subscriptionUrl).subscribe(function(e){T(function(t){return m.optimisticUpdate?m.optimisticUpdate(t,e):e}),p(m.cacheKey,m.optimisticUpdate,e)});return function(){return e()}}},[m.subscriptionUrl,m.optimisticUpdate,m.cacheKey]),{data:K,error:D,loading:k,refetch:j,mutate:T,cancel:x}}function w(e,t,n,r){var o;return a(this,void 0,void 0,function(){var a;return c(this,function(c){switch(c.label){case 0:return t?[4,l(e,{method:"POST",headers:i({"Content-Type":"application/json"},null==r?void 0:r.headers),body:JSON.stringify({query:t,variables:n}),cacheKey:null==r?void 0:r.cacheKey,signal:null==r?void 0:r.signal})]:[3,2];case 1:return[2,c.sent().data];case 2:return a=null!==(o=null==r?void 0:r.method)&&void 0!==o?o:"GET",[4,l(e,{method:a,headers:null==r?void 0:r.headers,cacheKey:null==r?void 0:r.cacheKey,signal:null==r?void 0:r.signal})];case 3:return[2,c.sent()]}})})}function g(e,t){return m(e,t)}function K(r,o){var u=this,s=e(!1),h=s[0],f=s[1],p=e(null),b=p[0],m=p[1],w=t(null),g=n(function(e,t){return void 0===t&&(t="POST"),a(u,void 0,void 0,function(){var n,u,s,h,p,b=this;return c(this,function(g){switch(g.label){case 0:f(!0),m(null),null===(h=w.current)||void 0===h||h.abort(),n=new AbortController,w.current=n,u=y(null!==(p=null==o?void 0:o.timeout)&&void 0!==p?p:1e4),s=function(n,f){return void 0===n&&(n=null!==(h=null==o?void 0:o.retry)&&void 0!==h?h:3),void 0===f&&(f=null!==(p=null==o?void 0:o.retryDelay)&&void 0!==p?p:500),a(b,void 0,void 0,function(){var a,h,y;return c(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,l(r,{method:t,headers:i({"Content-Type":"application/json"},null==o?void 0:o.headers),body:JSON.stringify(e),cacheKey:null==o?void 0:o.cacheKey,signal:u})];case 1:return a=c.sent(),(null==o?void 0:o.optimisticUpdate)&&o.cacheKey&&(d.setData(o.cacheKey,function(e){return o.optimisticUpdate(e,a)}),d.invalidate(o.cacheKey)),null===(y=null==o?void 0:o.onSuccess)||void 0===y||y.call(o,a),[2,a];case 2:if("AbortError"===(h=c.sent()).name)throw h;return[2,v(function(){return s(n-1,2*f)},n-1,2*f)];case 3:return[2]}})})},g.label=1;case 1:return g.trys.push([1,,3,4]),[4,s()];case 2:return[2,g.sent()];case 3:return f(!1),[7];case 4:return[2]}})})},[r,o]),K=n(function(){var e;return null===(e=w.current)||void 0===e?void 0:e.abort()},[]);return{mutate:g,loading:h,error:b,cancel:K}}function T(e,t){return m(e,{query:t.query,variables:t.variables,options:{cacheKey:t.cacheKey,staleTime:t.staleTime,headers:t.headers,timeout:t.timeout,retry:t.retry,retryDelay:t.retryDelay,optimisticUpdate:t.optimisticUpdate}})}function U(e,r){var o=this,u=r.mutation,s=r.variables,h=r.cacheKey,f=r.optimisticUpdate,p=r.retry,b=void 0===p?3:p,m=r.retryDelay,w=void 0===m?500:m,g=r.headers,K=r.timeout,T=void 0===K?1e4:K,U=t(null),D=n(function(){return a(o,void 0,void 0,function(){var t,n,r,o,p=this;return c(this,function(m){switch(m.label){case 0:null===(o=U.current)||void 0===o||o.abort(),t=new AbortController,U.current=t,n=y(T),r=function(t,o){return a(p,void 0,void 0,function(){var a,y;return c(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,l(e,{method:"POST",headers:i({"Content-Type":"application/json"},g),body:JSON.stringify({query:u,variables:s}),signal:n,cacheKey:h})];case 1:return a=c.sent(),f&&h&&d.setData(h,function(e){return f(e,a.data)}),h&&d.invalidate(h),[2,a.data];case 2:if("AbortError"===(y=c.sent()).name)throw y;return[2,v(function(){return r(t-1,2*o)},t-1,2*o)];case 3:return[2]}})})},m.label=1;case 1:return m.trys.push([1,,3,4]),[4,r(b,w)];case 2:return[2,m.sent()];case 3:return[7];case 4:return[2]}})})},[e,u,s,h,f,b,w,g,T]),S=n(function(){var e;null===(e=U.current)||void 0===e||e.abort()},[]);return{mutate:D,cancel:S}}export{f as SubscriptionManager,u as cache,y as createTimeoutSignal,d as queryRegistry,v as retryOperation,p as updateCache,U as useGraphQLMutation,T as useGraphQLQuery,m as useHybridQuery,K as useMutation,g as useQuery};
